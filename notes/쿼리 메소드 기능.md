# ëª©ì°¨
ğŸ€ [ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±](#ë©”ì†Œë“œ-ì´ë¦„ìœ¼ë¡œ-ì¿¼ë¦¬-ìƒì„±)    
ğŸ€ [JPA NamedQuery](#jpa-namedquery)    
ğŸ€ [@Query, ë ˆí¬ì§€í† ë¦¬ ë©”ì†Œë“œì— ì¿¼ë¦¬ ì •ì˜í•˜ê¸°](#query-ë ˆí¬ì§€í† ë¦¬-ë©”ì†Œë“œì—-ì¿¼ë¦¬-ì •ì˜í•˜ê¸°)    
ğŸ€ [@Query, ê°’, DTO ì¡°íšŒí•˜ê¸°](#query-ê°’-dto-ì¡°íšŒí•˜ê¸°)    
ğŸ€ [íŒŒë¼ë¯¸í„° ë°”ì¸ë”©](#íŒŒë¼ë¯¸í„°-ë°”ì¸ë”©)    
ğŸ€ [ë°˜í™˜ íƒ€ì…](#ë°˜í™˜-íƒ€ì…)    
ğŸ€ [ìˆœìˆ˜ JPA í˜ì´ì§•ê³¼ ì •ë ¬](#ìˆœìˆ˜-jpa-í˜ì´ì§•ê³¼-ì •ë ¬)    
ğŸ€ [ìŠ¤í”„ë§ ë°ì´í„° JPA í˜ì´ì§•ê³¼ ì •ë ¬](#ìŠ¤í”„ë§-ë°ì´í„°-jpa-í˜ì´ì§•ê³¼-ì •ë ¬)    
ğŸ€ [ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬](#ë²Œí¬ì„±-ìˆ˜ì •-ì¿¼ë¦¬)    
ğŸ€ [@EntityGraph](#entitygraph)    
ğŸ€ [JPA Hint & Lock](#jpa-hint--lock)    

## ì¿¼ë¦¬ ë©”ì†Œë“œ ê¸°ëŠ¥ 3ê°€ì§€
1. ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±
2. ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ JPA NamedQuery í˜¸ì¶œ
3. `@Query` ì• ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•´ì„œ `Repository` ì¸í„°í˜ì´ìŠ¤ì— ì¿¼ë¦¬ ì§ì ‘ ì •ì˜

## ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±
ë©”ì†Œë“œ ì´ë¦„ì„ ë¶„ì„í•´ì„œ `JPQL` ì¿¼ë¦¬ ì‹¤í–‰

ì´ë¦„ê³¼ ë‚˜ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ íšŒì› ì¡°íšŒí•˜ê¸°
#### ìˆœìˆ˜ JPA ë ˆí¬ì§€í† ë¦¬

```java
public List<Member> findByUsernameAndAgeGreaterThan(String username, int age) {
    em.createQuery("select m from Member m where m.username = :username and m.age > :age")
            .setParameter("username", username)
            .setParameter("age", age)
            .getResultList();
}
```

#### [ìŠ¤í”„ë§ ë°ì´í„° JPA](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java)
```java
public interface MemberRepository extends JpaRepository<Member, Long> {
    List<Member> findByUsernameAndAgeGreaterThan(String username, int age);
}
```
- ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ë©”ì†Œë“œ ì´ë¦„ì„ ë¶„ì„í•´ì„œ JPQLì„ ìƒì„±í•˜ê³  ì‹¤í–‰í•œë‹¤.

> ğŸ€ [ì¿¼ë¦¬ ë©”ì†Œë“œ í•„ë” ì¡°ê±´ ê³µì‹ ë¬¸ì„œ](https://docs.spring.io/spring-data/jpa/reference/jpa/query-methods.html)

##### ìŠ¤í”„ë§ ë°ì´í„° JPAê°€ ì œê³µí•˜ëŠ” ì¿¼ë¦¬ ë©”ì†Œë“œ ê¸°ëŠ¥
- ì¡°íšŒ: find...By, read...By, query...By, get...By
  - ì˜ˆ:) findHelloBy ì²˜ëŸ¼ ...ì— ì‹ë³„í•˜ê¸° ìœ„í•œ ë‚´ìš©(ì„¤ëª…)ì´ ë“¤ì–´ê°€ë„ ëœë‹¤. 
- COUNT: count...By ë°˜í™˜íƒ€ì… `long`
- EXISTS: exists...By ë°˜í™˜íƒ€ì… `boolean`
- ì‚­ì œ: delete...By, remove...By ë°˜í™˜íƒ€ì… `long` 
- DISTINCT: findDistinct, findMemberDistinctBy 
- LIMIT: findFirst3, findFirst, findTop, findTop3

> ğŸ€ ì´ ê¸°ëŠ¥ì€ ì—”í‹°í‹°ì˜ í•„ë“œëª…ì´ ë³€ê²½ë˜ë©´ ì¸í„°í˜ì´ìŠ¤ì— ì •ì˜í•œ ë©”ì„œë“œ ì´ë¦„ë„ ê¼­ í•¨ê»˜ ë³€ê²½í•´ì•¼ í•œë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•˜ëŠ” ì‹œì ì— ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤.  
> ì´ë ‡ê²Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì‹œì ì— ì˜¤ë¥˜ë¥¼ ì¸ì§€í•  ìˆ˜ ìˆëŠ” ê²ƒì´ ìŠ¤í”„ë§ ë°ì´í„° JPAì˜ ë§¤ìš° í° ì¥ì ì´ë‹¤.

## JPA NamedQuery
JPAì˜ `NamedQuery`ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆë‹¤.

### [`@NamedQuery` ì• ë…¸í…Œì´ì…˜ìœ¼ë¡œ Named ì¿¼ë¦¬ ì •ì˜í•˜ê¸° - Member](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Fentity%2FMember.java)
```java
@Entity
@NamedQuery(
        name = "Member.findByUsername",
        qeury = "SELECT m from Member m WHERE m.username = :username")
public class Member { ... }
```

### JPAë¥¼ ì§ì ‘ ì‚¬ìš©í•´ì„œ Named ì¿¼ë¦¬ í˜¸ì¶œí•˜ê¸°
```java
public class MemberRepository {
    public List<Member> findByUsername(String username) {
         ...
         List<Member> resultList = em.createNamedQuery("Member.findByUsername", Member.class)
                 .setParameter("username", username)
                 .getResultList();
    }
}
```

### [ìŠ¤í”„ë§ ë°ì´í„° JPAë¡œ Named ì¿¼ë¦¬ í˜¸ì¶œ - MemberRepository](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java)
```java
public interface MemberRepository extends JpaRepository<Member, Long> {
    ...
  
    List<Member> findByUsername(@Param("username") String username);
}
```
ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ì„ ì–¸í•œ "ë„ë©”ì¸ í´ë˜ìŠ¤ + .(ì ) + ë©”ì„œë“œ ì´ë¦„"ìœ¼ë¡œ Named ì¿¼ë¦¬ë¥¼ ì°¾ì•„ì„œ ì‹¤í–‰í•œë‹¤.  
ë§Œì•½ ì‹¤í–‰í•  Named ì¿¼ë¦¬ê°€ ì—†ìœ¼ë©´ ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„± ì „ëµì„ ì‚¬ìš©í•œë‹¤.  
í•„ìš”í•œ ì „ëµì„ ë³€ê²½í•  ìˆ˜ ìˆì§€ë§Œ, ê¶Œì¥í•˜ì§€ ì•ŠëŠ”ë‹¤.

> ğŸ€ ìŠ¤í”„ë§ ë°ì´í„° JPAë¥¼ ì‚¬ìš©í•˜ë©´ ì‹¤ë¬´ì—ì„œ Named Queryë¥¼ ì§ì ‘ ë“±ë¡í•´ì„œ ì‚¬ìš©í•˜ëŠ” ì¼ì€ ë“œë¬¼ë‹¤.   
> ëŒ€ì‹  `@Query`ë¥¼ ì‚¬ìš©í•´ì„œ ë¦¬í¬ì§€í† ë¦¬ ë©”ì†Œë“œì— ì¿¼ë¦¬ë¥¼ ì§ì ‘ ì •ì˜í•œë‹¤.

## @Query, ë ˆí¬ì§€í† ë¦¬ ë©”ì†Œë“œì— ì¿¼ë¦¬ ì •ì˜í•˜ê¸°
### [ë©”ì†Œë“œì— JPQL ì¿¼ë¦¬ ì‘ì„± - MemberRepository](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java)
```java
@Query("SELECT m FROM Member m WHERE m.username= :username AND m.age = :age")
List<Member> findUser(@Param("username") String username, @Param("age") int age);
```

`org.springframework.data.jpa.repository.Query` ì• ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•œë‹¤.  
ì‹¤í–‰í•  ë©”ì„œë“œì— ì •ì  ì¿¼ë¦¬ë¥¼ ì§ì ‘ ì‘ì„±í•˜ë¯€ë¡œ ì´ë¦„ì—†ëŠ” Named ì¿¼ë¦¬ë¼ê³  í•  ìˆ˜ ìˆë‹¤.  
JPA Named ì¿¼ë¦¬ ì²˜ëŸ¼ ì• í”„ë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œì ì— ë¬¸ë²• ì˜¤ë¥˜ë¥¼ ë°œê²¬í•  ìˆ˜ ìˆë‹¤.

> ğŸ€ ì‹¤ë¬´ì—ì„œëŠ” ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„± ê¸°ëŠ¥ì€ íŒŒë¼ë¯¸í„°ê°€ ì¦ê°€í•˜ë©´ ë©”ì„œë“œ ì´ë¦„ì´ ë§¤ìš° ì§€ì €ë¶„í•´ì§„ë‹¤. ë”°ë¼ì„œ `@Query` ê¸°ëŠ¥ì„ ìì£¼ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.

## @Query, ê°’, DTO ì¡°íšŒí•˜ê¸°
### [ë‹¨ìˆœíˆ ê°’ í•˜ë‚˜ë¥¼ ì¡°íšŒí•˜ê¸° - MemberRepository](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java) 
```java
public interface MemberRepository extends JpaRepository<Member, Long> {
    ...
    
    @Query("SELECT m.username FROM Member m")
    List<String> findUsernameList();
}
```
JPA ê°’ íƒ€ì…(`@Embedded`)ë„ ì´ ë°©ì‹ìœ¼ë¡œ ì¡°íšŒí•  ìˆ˜ ìˆë‹¤.

### DTOë¡œ ì§ì ‘ ì¡°íšŒ
#### [MemberDTO ìƒì„±](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Fdto%2FMemberDTO.java) 
```java
@Data
@AllArgsConstructor
public class MemberDTO {
    Long id;
    String username;
    String teamName;
}
```

#### [ë ˆí¬ì§€í† ë¦¬ì— ë©”ì†Œë“œ ì¶”ê°€ - MemberRepository](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java)
```java
@Query("SELECT new ddangme.springdatajpa.dto.MemberDTO(m.id, m.username, t.name) FROM Member m JOIN m.team t")
List<MemberDTO> findMemberDTO();
```
> ğŸš¨ DTOë¡œ ì§ì ‘ ì¡°íšŒí•˜ë ¤ë©´ JPAì˜ `new` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤. ê·¸ë¦¬ê³  ìƒì„±ìê°€ ë§ëŠ” DTOê°€ í•„ìš”í•˜ë‹¤. (JPAì™€ ì‚¬ìš©ë°©ì‹ì´ ë™ì¼í•˜ë‹¤.)

## íŒŒë¼ë¯¸í„° ë°”ì¸ë”©
- ìœ„ì¹˜ ê¸°ë°˜
- ì´ë¦„ ê¸°ë°˜

```sql
SELECT m FROM Member m WHERE m.username = ?0 // ìœ„ì¹˜ ê¸°ë°˜
SELECT m FROM Member m WHERE m.username = :name // ì´ë¦„ ê¸°ë°˜
```

### [íŒŒë¼ë¯¸í„° ë°”ì¸ë”© - MemberRepository](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java)
```java
@Query("SELECT m FROM Member m WHERE m.username = :name")
Member findMembers(@Param("name") String username);
```
> ğŸš¨ ì½”ë“œ ê°€ë…ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ë¥¼ ìœ„í•´ ì´ë¦„ ê¸°ë°˜ íŒŒë¼ë¯¸í„° ë°”ì¸ë”©ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.

### [ì»¬ë ‰ì…˜ íŒŒë¼ë¯¸í„° ë°”ì¸ë”© - MemberRepository](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java)
`Collection` íƒ€ì…ì„ `inì ˆ`ì„ ì§€ì›í•œë‹¤.
```java
@Query("SELECT m FROM Member m WHERE m.username in :names")
List<Member> findByNames(@Param("names") List<String> names);
```

## ë°˜í™˜ íƒ€ì…
ìŠ¤í”„ë¦´ ë°ì´í„° JPAëŠ” ìœ ì—°í•œ ë°˜í™˜ íƒ€ì…ì„ ì§€ì›í•œë‹¤.
```java
List<Member> findByUsername(String name); // ì»¬ë ‰ì…˜
Member findByUsername(String name); // ë‹¨ê±´
Optional<Member> findByUsername(String name); // ë‹¨ê±´ Optional
```

> ğŸ€ [ìŠ¤í”„ë§ ê³µì‹ ë¬¸ì„œ - ë°˜í™˜ íƒ€ì…](https://docs.spring.io/spring-data/jpa/reference/repositories/query-return-types-reference.html)

### ì¡°íšŒ ê²°ê³¼ê°€ ë§ê±°ë‚˜ ì—†ì„ ê²½ìš°
- ì»¬ë ‰ì…˜
  - ê²°ê³¼ ì—†ìŒ: ë¹ˆ ì»¬ë ‰ì…˜ ë°˜í™˜
- ë‹¨ê±´ ì¡°íšŒ
  - ê²°ê³¼ ì—†ìŒ: `null` ë°˜í™˜
  - ê²°ê³¼ê°€ 2ê±´ ì´ìƒ: `javax.persistence.NonUniqueResultException` ì˜ˆì™¸ ë°œìƒ

> ğŸ€ ë‹¨ê±´ìœ¼ë¡œ ì§€ì •í•œ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ë‚´ë¶€ì—ì„œ JPQLì˜ `Query.getSingleResult()` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤. ì´ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí–ˆì„ ë•Œ   
> ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ `javax.persistence.NoResultException` ì˜ˆì™¸ê°€ ë°œìƒí•˜ê¸° ë•Œë¬¸ì— ê°œë°œì ì…ì¥ì—ì„œ ë‹¤ë£¨ê¸°ê°€ ìƒë‹¹íˆ ë¶ˆí¸í•˜ë‹¤.  
> ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ë‹¨ê±´ì„ ì¡°íšŒí•  ë•Œ ì´ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ì˜ˆì™¸ë¥¼ ë¬´ì‹œí•˜ê³  ëŒ€ì‹ ì— `null`ì„ ë°˜í™˜í•œë‹¤.

## ìˆœìˆ˜ JPA í˜ì´ì§•ê³¼ ì •ë ¬
ë‹¤ìŒ ì¡°ê±´ìœ¼ë¡œ í˜ì´ì§•ê³¼ ì •ë ¬ì„ í•œë‹¤.
- ê²€ìƒ‰ ì¡°ê±´: ë‚˜ì´ê°€ 10ì‚´
- ì •ë ¬ ì¡°ê±´: ì´ë¦„ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ
- í˜ì´ì§• ì¡°ê±´: ì²« ë²ˆì§¸ í˜ì´ì§€, í˜ì´ì§€ë‹¹ ë³´ì—¬ì¤„ ë°ì´í„°ëŠ” 3ê±´

### JPA í˜ì´ì§• ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ
```java
public List<Member> findByPage(int age, int offset, int limit) {
  return em.createQuery("select m from Member m where m.age = :age order by m.username desc")
                  .setParameter("age", age)
                  .setFirstResult(offset)
                  .setMaxResults(limit)
                  .getResultList();
}

public long totalCount(int age) {
    return em.createQuery("select count(m) from Member m where m.age = :age", Long.class)
            .setParameter("age", age)
            .getSingleResult();
}
```

## ìŠ¤í”„ë§ ë°ì´í„° JPA í˜ì´ì§•ê³¼ ì •ë ¬
## ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬
## @EntityGraph
## JPA Hint & Lock