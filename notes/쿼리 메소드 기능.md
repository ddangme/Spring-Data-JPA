# ëª©ì°¨
ğŸ€ [ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±](#ë©”ì†Œë“œ-ì´ë¦„ìœ¼ë¡œ-ì¿¼ë¦¬-ìƒì„±)    
ğŸ€ [JPA NamedQuery](#jpa-namedquery)    
ğŸ€ [@Query, ë ˆí¬ì§€í† ë¦¬ ë©”ì†Œë“œì— ì¿¼ë¦¬ ì •ì˜í•˜ê¸°](#query-ë ˆí¬ì§€í† ë¦¬-ë©”ì†Œë“œì—-ì¿¼ë¦¬-ì •ì˜í•˜ê¸°)    
ğŸ€ [@Query, ê°’, DTO ì¡°íšŒí•˜ê¸°](#query-ê°’-dto-ì¡°íšŒí•˜ê¸°)    
ğŸ€ [íŒŒë¼ë¯¸í„° ë°”ì¸ë”©](#íŒŒë¼ë¯¸í„°-ë°”ì¸ë”©)    
ğŸ€ [ë°˜í™˜ íƒ€ì…](#ë°˜í™˜-íƒ€ì…)    
ğŸ€ [ìˆœìˆ˜ JPA í˜ì´ì§•ê³¼ ì •ë ¬](#ìˆœìˆ˜-jpa-í˜ì´ì§•ê³¼-ì •ë ¬)    
ğŸ€ [ìŠ¤í”„ë§ ë°ì´í„° JPA í˜ì´ì§•ê³¼ ì •ë ¬](#ìŠ¤í”„ë§-ë°ì´í„°-jpa-í˜ì´ì§•ê³¼-ì •ë ¬)    
ğŸ€ [ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬](#ë²Œí¬ì„±-ìˆ˜ì •-ì¿¼ë¦¬)    
ğŸ€ [@EntityGraph](#entitygraph)    
ğŸ€ [JPA Hint & Lock](#jpa-hint--lock)    

## ì¿¼ë¦¬ ë©”ì†Œë“œ ê¸°ëŠ¥ 3ê°€ì§€
1. ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±
2. ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ JPA NamedQuery í˜¸ì¶œ
3. `@Query` ì• ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•´ì„œ `Repository` ì¸í„°í˜ì´ìŠ¤ì— ì¿¼ë¦¬ ì§ì ‘ ì •ì˜

## ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±
ë©”ì†Œë“œ ì´ë¦„ì„ ë¶„ì„í•´ì„œ `JPQL` ì¿¼ë¦¬ ì‹¤í–‰

ì´ë¦„ê³¼ ë‚˜ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ íšŒì› ì¡°íšŒí•˜ê¸°
#### ìˆœìˆ˜ JPA ë ˆí¬ì§€í† ë¦¬

```java
public List<Member> findByUsernameAndAgeGreaterThan(String username, int age) {
    em.createQuery("select m from Member m where m.username = :username and m.age > :age")
            .setParameter("username", username)
            .setParameter("age", age)
            .getResultList();
}
```

#### [ìŠ¤í”„ë§ ë°ì´í„° JPA](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java)
```java
public interface MemberRepository extends JpaRepository<Member, Long> {
    List<Member> findByUsernameAndAgeGreaterThan(String username, int age);
}
```
- ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ë©”ì†Œë“œ ì´ë¦„ì„ ë¶„ì„í•´ì„œ JPQLì„ ìƒì„±í•˜ê³  ì‹¤í–‰í•œë‹¤.

> ğŸ€ [ì¿¼ë¦¬ ë©”ì†Œë“œ í•„ë” ì¡°ê±´ ê³µì‹ ë¬¸ì„œ](https://docs.spring.io/spring-data/jpa/reference/jpa/query-methods.html)

##### ìŠ¤í”„ë§ ë°ì´í„° JPAê°€ ì œê³µí•˜ëŠ” ì¿¼ë¦¬ ë©”ì†Œë“œ ê¸°ëŠ¥
- ì¡°íšŒ: find...By, read...By, query...By, get...By
  - ì˜ˆ:) findHelloBy ì²˜ëŸ¼ ...ì— ì‹ë³„í•˜ê¸° ìœ„í•œ ë‚´ìš©(ì„¤ëª…)ì´ ë“¤ì–´ê°€ë„ ëœë‹¤. 
- COUNT: count...By ë°˜í™˜íƒ€ì… `long`
- EXISTS: exists...By ë°˜í™˜íƒ€ì… `boolean`
- ì‚­ì œ: delete...By, remove...By ë°˜í™˜íƒ€ì… `long` 
- DISTINCT: findDistinct, findMemberDistinctBy 
- LIMIT: findFirst3, findFirst, findTop, findTop3

> ğŸ€ ì´ ê¸°ëŠ¥ì€ ì—”í‹°í‹°ì˜ í•„ë“œëª…ì´ ë³€ê²½ë˜ë©´ ì¸í„°í˜ì´ìŠ¤ì— ì •ì˜í•œ ë©”ì„œë“œ ì´ë¦„ë„ ê¼­ í•¨ê»˜ ë³€ê²½í•´ì•¼ í•œë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•˜ëŠ” ì‹œì ì— ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤.  
> ì´ë ‡ê²Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì‹œì ì— ì˜¤ë¥˜ë¥¼ ì¸ì§€í•  ìˆ˜ ìˆëŠ” ê²ƒì´ ìŠ¤í”„ë§ ë°ì´í„° JPAì˜ ë§¤ìš° í° ì¥ì ì´ë‹¤.

## JPA NamedQuery
JPAì˜ `NamedQuery`ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆë‹¤.

### [`@NamedQuery` ì• ë…¸í…Œì´ì…˜ìœ¼ë¡œ Named ì¿¼ë¦¬ ì •ì˜í•˜ê¸° - Member](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Fentity%2FMember.java)
```java
@Entity
@NamedQuery(
        name = "Member.findByUsername",
        qeury = "SELECT m from Member m WHERE m.username = :username")
public class Member { ... }
```

### JPAë¥¼ ì§ì ‘ ì‚¬ìš©í•´ì„œ Named ì¿¼ë¦¬ í˜¸ì¶œí•˜ê¸°
```java
public class MemberRepository {
    public List<Member> findByUsername(String username) {
         ...
         List<Member> resultList = em.createNamedQuery("Member.findByUsername", Member.class)
                 .setParameter("username", username)
                 .getResultList();
    }
}
```

### [ìŠ¤í”„ë§ ë°ì´í„° JPAë¡œ Named ì¿¼ë¦¬ í˜¸ì¶œ - MemberRepository](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java)
```java
public interface MemberRepository extends JpaRepository<Member, Long> {
    ...
  
    List<Member> findByUsername(@Param("username") String username);
}
```
ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ì„ ì–¸í•œ "ë„ë©”ì¸ í´ë˜ìŠ¤ + .(ì ) + ë©”ì„œë“œ ì´ë¦„"ìœ¼ë¡œ Named ì¿¼ë¦¬ë¥¼ ì°¾ì•„ì„œ ì‹¤í–‰í•œë‹¤.  
ë§Œì•½ ì‹¤í–‰í•  Named ì¿¼ë¦¬ê°€ ì—†ìœ¼ë©´ ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„± ì „ëµì„ ì‚¬ìš©í•œë‹¤.  
í•„ìš”í•œ ì „ëµì„ ë³€ê²½í•  ìˆ˜ ìˆì§€ë§Œ, ê¶Œì¥í•˜ì§€ ì•ŠëŠ”ë‹¤.

> ğŸ€ ìŠ¤í”„ë§ ë°ì´í„° JPAë¥¼ ì‚¬ìš©í•˜ë©´ ì‹¤ë¬´ì—ì„œ Named Queryë¥¼ ì§ì ‘ ë“±ë¡í•´ì„œ ì‚¬ìš©í•˜ëŠ” ì¼ì€ ë“œë¬¼ë‹¤.   
> ëŒ€ì‹  `@Query`ë¥¼ ì‚¬ìš©í•´ì„œ ë¦¬í¬ì§€í† ë¦¬ ë©”ì†Œë“œì— ì¿¼ë¦¬ë¥¼ ì§ì ‘ ì •ì˜í•œë‹¤.

## @Query, ë ˆí¬ì§€í† ë¦¬ ë©”ì†Œë“œì— ì¿¼ë¦¬ ì •ì˜í•˜ê¸°
### [ë©”ì†Œë“œì— JPQL ì¿¼ë¦¬ ì‘ì„± - MemberRepository](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java)
```java
@Query("SELECT m FROM Member m WHERE m.username= :username AND m.age = :age")
List<Member> findUser(@Param("username") String username, @Param("age") int age);
```

`org.springframework.data.jpa.repository.Query` ì• ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•œë‹¤.  
ì‹¤í–‰í•  ë©”ì„œë“œì— ì •ì  ì¿¼ë¦¬ë¥¼ ì§ì ‘ ì‘ì„±í•˜ë¯€ë¡œ ì´ë¦„ì—†ëŠ” Named ì¿¼ë¦¬ë¼ê³  í•  ìˆ˜ ìˆë‹¤.  
JPA Named ì¿¼ë¦¬ ì²˜ëŸ¼ ì• í”„ë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œì ì— ë¬¸ë²• ì˜¤ë¥˜ë¥¼ ë°œê²¬í•  ìˆ˜ ìˆë‹¤.

> ğŸ€ ì‹¤ë¬´ì—ì„œëŠ” ë©”ì†Œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„± ê¸°ëŠ¥ì€ íŒŒë¼ë¯¸í„°ê°€ ì¦ê°€í•˜ë©´ ë©”ì„œë“œ ì´ë¦„ì´ ë§¤ìš° ì§€ì €ë¶„í•´ì§„ë‹¤. ë”°ë¼ì„œ `@Query` ê¸°ëŠ¥ì„ ìì£¼ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.

## @Query, ê°’, DTO ì¡°íšŒí•˜ê¸°
### [ë‹¨ìˆœíˆ ê°’ í•˜ë‚˜ë¥¼ ì¡°íšŒí•˜ê¸° - MemberRepository](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java) 
```java
public interface MemberRepository extends JpaRepository<Member, Long> {
    ...
    
    @Query("SELECT m.username FROM Member m")
    List<String> findUsernameList();
}
```
JPA ê°’ íƒ€ì…(`@Embedded`)ë„ ì´ ë°©ì‹ìœ¼ë¡œ ì¡°íšŒí•  ìˆ˜ ìˆë‹¤.

### DTOë¡œ ì§ì ‘ ì¡°íšŒ
#### [MemberDTO ìƒì„±](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Fdto%2FMemberDTO.java) 
```java
@Data
@AllArgsConstructor
public class MemberDTO {
    Long id;
    String username;
    String teamName;
}
```

#### [ë ˆí¬ì§€í† ë¦¬ì— ë©”ì†Œë“œ ì¶”ê°€ - MemberRepository](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java)
```java
@Query("SELECT new ddangme.springdatajpa.dto.MemberDTO(m.id, m.username, t.name) FROM Member m JOIN m.team t")
List<MemberDTO> findMemberDTO();
```
> ğŸš¨ DTOë¡œ ì§ì ‘ ì¡°íšŒí•˜ë ¤ë©´ JPAì˜ `new` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤. ê·¸ë¦¬ê³  ìƒì„±ìê°€ ë§ëŠ” DTOê°€ í•„ìš”í•˜ë‹¤. (JPAì™€ ì‚¬ìš©ë°©ì‹ì´ ë™ì¼í•˜ë‹¤.)

## íŒŒë¼ë¯¸í„° ë°”ì¸ë”©
- ìœ„ì¹˜ ê¸°ë°˜
- ì´ë¦„ ê¸°ë°˜

```sql
SELECT m FROM Member m WHERE m.username = ?0 // ìœ„ì¹˜ ê¸°ë°˜
SELECT m FROM Member m WHERE m.username = :name // ì´ë¦„ ê¸°ë°˜
```

### [íŒŒë¼ë¯¸í„° ë°”ì¸ë”© - MemberRepository](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java)
```java
@Query("SELECT m FROM Member m WHERE m.username = :name")
Member findMembers(@Param("name") String username);
```
> ğŸš¨ ì½”ë“œ ê°€ë…ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ë¥¼ ìœ„í•´ ì´ë¦„ ê¸°ë°˜ íŒŒë¼ë¯¸í„° ë°”ì¸ë”©ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.

### [ì»¬ë ‰ì…˜ íŒŒë¼ë¯¸í„° ë°”ì¸ë”© - MemberRepository](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java)
`Collection` íƒ€ì…ì„ `inì ˆ`ì„ ì§€ì›í•œë‹¤.
```java
@Query("SELECT m FROM Member m WHERE m.username in :names")
List<Member> findByNames(@Param("names") List<String> names);
```

## ë°˜í™˜ íƒ€ì…
ìŠ¤í”„ë¦´ ë°ì´í„° JPAëŠ” ìœ ì—°í•œ ë°˜í™˜ íƒ€ì…ì„ ì§€ì›í•œë‹¤.
```java
List<Member> findByUsername(String name); // ì»¬ë ‰ì…˜
Member findByUsername(String name); // ë‹¨ê±´
Optional<Member> findByUsername(String name); // ë‹¨ê±´ Optional
```

> ğŸ€ [ìŠ¤í”„ë§ ê³µì‹ ë¬¸ì„œ - ë°˜í™˜ íƒ€ì…](https://docs.spring.io/spring-data/jpa/reference/repositories/query-return-types-reference.html)

### ì¡°íšŒ ê²°ê³¼ê°€ ë§ê±°ë‚˜ ì—†ì„ ê²½ìš°
- ì»¬ë ‰ì…˜
  - ê²°ê³¼ ì—†ìŒ: ë¹ˆ ì»¬ë ‰ì…˜ ë°˜í™˜
- ë‹¨ê±´ ì¡°íšŒ
  - ê²°ê³¼ ì—†ìŒ: `null` ë°˜í™˜
  - ê²°ê³¼ê°€ 2ê±´ ì´ìƒ: `javax.persistence.NonUniqueResultException` ì˜ˆì™¸ ë°œìƒ

> ğŸ€ ë‹¨ê±´ìœ¼ë¡œ ì§€ì •í•œ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ë‚´ë¶€ì—ì„œ JPQLì˜ `Query.getSingleResult()` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤. ì´ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí–ˆì„ ë•Œ   
> ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ `javax.persistence.NoResultException` ì˜ˆì™¸ê°€ ë°œìƒí•˜ê¸° ë•Œë¬¸ì— ê°œë°œì ì…ì¥ì—ì„œ ë‹¤ë£¨ê¸°ê°€ ìƒë‹¹íˆ ë¶ˆí¸í•˜ë‹¤.  
> ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ë‹¨ê±´ì„ ì¡°íšŒí•  ë•Œ ì´ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ì˜ˆì™¸ë¥¼ ë¬´ì‹œí•˜ê³  ëŒ€ì‹ ì— `null`ì„ ë°˜í™˜í•œë‹¤.

## ìˆœìˆ˜ JPA í˜ì´ì§•ê³¼ ì •ë ¬
ë‹¤ìŒ ì¡°ê±´ìœ¼ë¡œ í˜ì´ì§•ê³¼ ì •ë ¬ì„ í•œë‹¤.
- ê²€ìƒ‰ ì¡°ê±´: ë‚˜ì´ê°€ 10ì‚´
- ì •ë ¬ ì¡°ê±´: ì´ë¦„ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ
- í˜ì´ì§• ì¡°ê±´: ì²« ë²ˆì§¸ í˜ì´ì§€, í˜ì´ì§€ë‹¹ ë³´ì—¬ì¤„ ë°ì´í„°ëŠ” 3ê±´

### JPA í˜ì´ì§• ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ
```java
public List<Member> findByPage(int age, int offset, int limit) {
  return em.createQuery("select m from Member m where m.age = :age order by m.username desc")
                  .setParameter("age", age)
                  .setFirstResult(offset)
                  .setMaxResults(limit)
                  .getResultList();
}

public long totalCount(int age) {
    return em.createQuery("select count(m) from Member m where m.age = :age", Long.class)
            .setParameter("age", age)
            .getSingleResult();
}
```

### í…ŒìŠ¤íŠ¸ ì½”ë“œ
```java
@Test
public void paging() throws Exception {
    //given
    memberJpaRepository.save(new Member("member1", 10));
    memberJpaRepository.save(new Member("member2", 10));
    memberJpaRepository.save(new Member("member3", 10));
    memberJpaRepository.save(new Member("member4", 10));
    memberJpaRepository.save(new Member("member5", 10));
    int age = 10;
    int offset = 0;
    int limit = 3;
    
    //when
    List<Member> members = memberJpaRepository.findByPage(age, offset, limit);
    long totalCount = memberJpaRepository.totalCount(age);
    //í˜ì´ì§€ ê³„ì‚° ê³µì‹ ì ìš©...
    // totalPage = totalCount / size ... // ë§ˆì§€ë§‰ í˜ì´ì§€ ...
    // ìµœì´ˆ í˜ì´ì§€ ..
  
    //then
    assertThat(members.size()).isEqualTo(3);
    assertThat(totalCount).isEqualTo(5);
}
```

## ìŠ¤í”„ë§ ë°ì´í„° JPA í˜ì´ì§•ê³¼ ì •ë ¬
### í˜ì´ì§•ê³¼ ì •ë ¬ íŒŒë¼ë¯¸í„°
- `org.springframework.data.domain.Sort`: ì •ë ¬ ê¸°ëŠ¥  
- `org.springframework.data.domain.Pageable`: í˜ì´ì§• ê¸°ëŠ¥ (ë‚´ë¶€ì— `Sort` í¬í•¨)

### íŠ¹ë³„í•œ ë°˜í™˜ íƒ€ì…
- `org.springframework.data.domain.Page`: ì¶”ê°€ count ì¿¼ë¦¬ ê²°ê³ ã…˜ë¥¼ í¬í•¨í•˜ëŠ” í˜ì´ì§•
- `org.springframework.data.domain.Slice`: ì¶”ê°€ count ì¿¼ë¦¬ ì—†ì´ ë‹¤ìŒ í˜ì´ì§€ë§Œ í™•ì¸ ê°€ëŠ¥(ë‚´ë¶€ì ìœ¼ë¡œ limit + 1ì¡°íšŒ)
- `List`(ìë°” ì»¬ë ‰ì…˜): ì¶”ê°€ count ì¿¼ë¦¬ ì—†ì´ ê²°ê³¼ë§Œ ë°˜í™˜

### í˜ì´ì§•ê³¼ ì •ë ¬ ì‚¬ìš© ì˜ˆì œ
```java
Page<Member> findByUsername(String name, Pageable pageable); //count ì¿¼ë¦¬ ì‚¬ìš©
Slice<Member> findByUsername(String name, Pageable pageable); //count ì¿¼ë¦¬ ì‚¬ìš© ì•ˆí•¨ 
List<Member> findByUsername(String name, Pageable pageable); //count ì¿¼ë¦¬ ì‚¬ìš© ì•ˆí•¨ 
List<Member> findByUsername(String name, Sort sort);
```

ì•„ë˜ ì¡°ê±´ìœ¼ë¡œ í˜ì´ì§•ê³¼ ì •ë ¬ì„ í•˜ëŠ” ì˜ˆì œ ì½”ë“œ ì‘ì„±í•˜ê¸°
- ê²€ìƒ‰ ì¡°ê±´: ë‚˜ì´ê°€ 10ì‚´
- ì •ë ¬ ì¡°ê±´: ì´ë¦„ ë‚´ë¦¼ì°¨ìˆœ
- í˜ì´ì§• ì¡°ê±´: ì²« ë²ˆì§¸ í˜ì´ì§€, í˜ì´ì§€ë‹¹ ë³´ì—¬ì¤„ ë°ì´í„°ëŠ” 3ê±´

#### [Page ì‚¬ìš© ì˜ˆì œ ì •ì˜ ì½”ë“œ - MemberRepository](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java)
```java
Page<Member> findByAge(int age, Pageable pageable);
```
- ë‘ ë²ˆì§¸ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì€ `Pageable`ì€ ì¸í„°í˜ì´ìŠ¤ ì´ë‹¤. ë”°ë¼ì„œ ì‹¤ì œ ì‚¬ìš©í•  ë•ŒëŠ” í•´ë‹¹ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ
  `org.springframework.data.domain.PageRequest` ê°ì²´ë¥¼ ì‚¬ìš©í•œë‹¤.
- `PageRequest` ìƒì„±ìì˜ ì²« ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì—ëŠ” í˜„ì¬ í˜ì´ì§€ë¥¼, ë‘ ë²ˆì§¸ íŒŒë¼ë¯¸í„°ì—ëŠ” ì¡°íšŒí•  ë°ì´í„° ìˆ˜ë¥¼ ì…ë ¥í•œë‹¤.
  ì—¬ê¸°ì— ì¶”ê°€ë¡œ ì •ë ¬ ì •ë³´ë„ íŒŒë¼ë¯¸í„°ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

> ğŸš¨ PageëŠ” 0ë¶€í„° ì‹œì‘ì´ë‹¤.


#### [Page ì‚¬ìš© ì˜ˆì œ ì‹¤í–‰ ì½”ë“œ - MemberRepositoryTest](..%2Fsrc%2Ftest%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepositoryTest.java) 
```java
@Test
void page() throws Exception {
    // given
    memberRepository.save(new Member("member1", 10));
    memberRepository.save(new Member("member2", 10));
    memberRepository.save(new Member("member3", 10));
    memberRepository.save(new Member("member4", 10));
    memberRepository.save(new Member("member5", 10));
  
    // when
    PageRequest pageRequest = PageRequest.of(0, 3, Sort.by(Sort.Direction.DESC, "username"));
    Page<Member> page = memberRepository.findByAge(10, pageRequest);
  
    // then
    List<Member> content = page.getContent(); // ì¡°íšŒëœ ë°ì´í„°
    assertThat(content.size()).isEqualTo(3); // ì¡°íšŒëœ ë°ì´í„° ìˆ˜
    assertThat(page.getTotalElements()).isEqualTo(5); // ì „ì²´ ë°ì´í„° ìˆ˜
    assertThat(page.getNumber()).isEqualTo(0); // í˜ì´ì§€ ë²ˆí˜¸
    assertThat(page.getTotalPages()).isEqualTo(2); // ì „ì²´ í˜ì´ì§€ ìˆ˜
    assertThat(page.isFirst()).isTrue(); // ì²« ë²ˆì§¸ í˜ì´ì§€ì¸ê°€?
    assertThat(page.hasNext()).isTrue(); // ë‹¤ìŒ í˜ì´ì§€ê°€ ìˆëŠ”ê°€?
}
```

### Page ì¸í„°í˜ì´ìŠ¤
```java
public interface Page<T> extends Slice<T> {
    int getTotalPages(); //ì „ì²´ í˜ì´ì§€ ìˆ˜
    long getTotalElements(); //ì „ì²´ ë°ì´í„° ìˆ˜
    <U> Page<U> map(Function<? super T, ? extends U> converter); //ë³€í™˜ê¸°
}
```

### Slice ì¸í„°í˜ì´ìŠ¤
```java
public interface Slice<T> extends Streamable<T> {
    int getNumber();              // í˜„ì¬ í˜ì´ì§€
    int getSize();                // í˜ì´ì§€ í¬ê¸°
    int getNumberOfElements();    // í˜„ì¬ í˜ì´ì§€ì— ë‚˜ì˜¬ ë°ì´í„° ìˆ˜
    List<T> getContent();         // ì¡°íšŒëœ ë°ì´í„°
    boolean hasContent();         // ì¡°íšŒëœ ë°ì´í„° ì¡´ì¬ ì—¬ë¶€
    Sort getSort();               // ì •ë ¬ ì •ë³´
    boolean isFirst();            // í˜„ì¬ í˜ì´ì§€ê°€ ì²« í˜ì´ì§€ì¸ì§€ ì—¬ë¶€
    boolean isLast();             // í˜„ì¬ í˜ì´ì§€ê°€ ë§ˆì§€ë§‰ í˜ì´ì§€ì¸ì§€ ì—¬ë¶€
    boolean hasNext();            // ë‹¤ìŒ í˜ì´ì§€ ì—¬ë¶€
    boolean hasPrevious();        // ì´ì „ í˜ì´ì§€ ì—¬ë¶€
    Pageable getPageable(); //í˜ì´ì§€ ìš”ì²­ ì •ë³´
    Pageable nextPageable(); //ë‹¤ìŒ í˜ì´ì§€ ê°ì²´
    Pageable previousPageable();//ì´ì „ í˜ì´ì§€ ê°ì²´
    <U> Slice<U> map(Function<? super T, ? extends U> converter); //ë³€í™˜ê¸°
}
```

> ğŸ€ count ì¿¼ë¦¬ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ë¶„ë¦¬í•  ìˆ˜ ìˆë‹¤.
> ```java
> @Query(value = "select m from Member m",
>        countQuery = "select count(m.username) from Member m")
> Page<Member> findMemberAllCountBy(Pageable pageable);
> ```

> ğŸ€ í˜ì´ì§€ë¥¼ ìœ ì§€í•˜ë©´ì„œ ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜í•˜ê¸°
> ```java
> Page<Member> page = memberRepository.findByAge(10, pageRequest);
> Page<MemberDTO> dtoPage = page.map(m -> new MemberDTO());
> ```


###### ğŸ€ìŠ¤í”„ë§ ë¶€íŠ¸ 3 - í•˜ì´ë²„ë„¤ì´íŠ¸ 6 Left Join ìµœì í™” ì„¤ëª…
ìŠ¤í”„ë§ ë¶€íŠ¸ 3 ì´ìƒì„ ì‚¬ìš©í•˜ë©´ í•˜ì´ë²„ë„¤ì´íŠ¸ 6ì´ ì ìš©ëœë‹¤.

ì´ê²½ìš° í•˜ì´ë²„ë„¤ì´íŠ¸ 6ì—ì„œ ì˜ë¯¸ì—†ëŠ” Left Joinì„ ìµœì í™” í•œë‹¤. ë”°ë¼ì„œ
ë‹¤ìŒì„ ì‹¤í–‰í•˜ë©´ SQLì´ LEFT JOINì„ í•˜ì§€ ì•ŠëŠ” ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤.
```java
@Query(value = "SELECT m FROM Member m LEFT JOIN m.team t")
Page<Member> findByAge(int age, Pageable pageable);
```

ì‹¤í–‰ ê²°ê³¼
```text
SELECT
    m.member_id,
    m.age,
    m.team_id,
    m.username
FROM
    member m
```

í•˜ì´ë²„ë„¤ì´íŠ¸ 6ì€ ì´ëŸ° ê²½ìš° ì™œ Left Joinì„ ì œê±°í•˜ëŠ” ìµœì í™”ë¥¼ í• ê¹Œ?  
ì‹¤í–‰í•œ JPQLì„ ë³´ë©´ Left Joinì„ ì‚¬ìš©í•˜ê³  ìˆë‹¤.
`SELECT m FROM Member m LEFT JOIN m.team t`
`Member`ì™€ `Team`ì„ ì¡°ì¸í•˜ì§€ë§Œ ì‚¬ì‹¤ ì´ ì¿¼ë¦¬ëŠ” `Team`ì„ ì „í˜€ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
`SELECT` ì ˆì´ë‚˜, `WHERE`ì ˆì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ëœ»ì´ë‹¤.
ê·¸ë ‡ë‹¤ë©´ ì´ JPQLì€ ì‚¬ì‹¤ìƒ ë‹¤ìŒê³¼ ê°™ë‹¤.
`SELECT m FROM Member m`
`Left Join` ì´ê¸° ë•Œë¬¸ì— ì™¼ìª½ì— ìˆëŠ” `member` ìì²´ë¥¼ ë‹¤ ì¡°íšŒí•œë‹¤ëŠ” ëœ»ì´ ëœë‹¤.
ë§Œì•½ `select`ë‚˜ `where`ì— `team`ì˜ ì¡°ê±´ì´ ë“¤ì–´ê°„ë‹¤ë©´ ì •ìƒì ì¸ `join`ë¬¸ì´ ë³´ì¸ë‹¤.
JPAëŠ” ì´ ê²½ìš° ìµœì í™”ë¥¼ í•´ì„œ `join` ì—†ì´ í•´ë‹¹ ë‚´ìš©ë§Œìœ¼ë¡œ SQLì„ ë§Œë“ ë‹¤.
ì—¬ê¸°ì„œ ë§Œì•½ `Member`ì™€ `Team`ì„ í•˜ë‚˜ì˜ SQLë¡œ ì¡°íšŒí•´ì•¼ í•  ë• JPAê°€
ì œê³µí•˜ëŠ” `Fetch Join`ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
`SELECT m FROM Member m LEFT JOIN FETCH m.team t`
ì´ ê²½ìš°ì—ë„ SQLì—ì„œ joinë¬¸ì€ ì •ìƒ ìˆ˜í–‰ëœë‹¤.

## ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬
> ğŸ€ ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬ë€?  
> í•œ ë²ˆì— ì—¬ëŸ¬ ê°œì˜ ë ˆì½”ë“œë¥¼ ë³€ê²½í•˜ëŠ” ì¿¼ë¦¬ë¥¼ ë§í•œë‹¤. ê°œë³„ ì—”í‹°í‹°ë¥¼ í•˜ë‚˜ì”© ìˆ˜ì •í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ, ëŒ€ëŸ‰ì˜ ë°ì´í„°ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ìˆ˜ì •í•˜ëŠ” ê²ƒì´ë‹¤.

### JPAë¥¼ ì‚¬ìš©í•œ ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬
```java
public int bulkAgePlus(int age) {
    return em.createQuery(
              "UPDATE Member m SET m.age = m.age + 1 WHERE m.age >= :age")
            .setParameter("age", age)
            .executeUpdate();
}
```

### JPAë¥¼ ì‚¬ìš©í•œ ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸ ì½”ë“œ
```java
@Test
public void bulkUpdate() throws Exception {
    //given
    memberJpaRepository.save(new Member("member1", 10));
    memberJpaRepository.save(new Member("member2", 19));
    memberJpaRepository.save(new Member("member3", 20));
    memberJpaRepository.save(new Member("member4", 21));
    memberJpaRepository.save(new Member("member5", 40));
    //when
    int resultCount = memberJpaRepository.bulkAgePlus(20);
    //then
    assertThat(resultCount).isEqualTo(3);
 }
```

### [ìŠ¤í”„ë§ ë°ì´í„° JPAë¥¼ ì‚¬ìš©í•œ ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬ - MemberRepository](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java)
```java
@Modifying
@Query("UPDATE Member m SET m.age = m.age + 1 WHERE m.age >= :age")
int bulkAgePlus(@Param("age") int age);
```

### [ìŠ¤í”„ë§ ë°ì´í„° JPAë¥¼ ì‚¬ìš©í•œ ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸ ì½”ë“œ - MemberRepositoryTest](..%2Fsrc%2Ftest%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepositoryTest.java)
```java
@Test
void bulkUpdate() throws Exception {
    // given
    memberRepository.save(new Member("member1", 10));
    memberRepository.save(new Member("member2", 19));
    memberRepository.save(new Member("member3", 20));
    memberRepository.save(new Member("member4", 21));
    memberRepository.save(new Member("member5", 40));
    
    // when 
    int resultCount = memberRepository.bulkAgePlus(20);
    
    // then
    assertThat(resultCount).isEqualTo(3);
}
```
- ë²Œí¬ì„± ìˆ˜ì •, ì‚­ì œ ì¿¼ë¦¬ëŠ” `@Modifying` ì• ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
  - ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ `org.hibernate.hql.internal.QueryExecutionRequestException: Not supported for DML operations` ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤.
- ë²Œí¬ì„± ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ê³  ë‚˜ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”: `@Modifying(clearAutomatically = true)`
  - ì´ ì˜µì…˜ì˜ ê¸°ë³¸ ê°’ì€ (`false`)ì´ë‹¤.
  - ì´ ì˜µì…˜ ì—†ì´ íšŒì›ì„ `findById`ë¡œ ë‹¤ì‹œ ì¡°íšŒí•˜ë©´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ê³¼ê±° ê°’ì´ ë‚¨ì•„ì„œ ë¬¸ì œê°€ ë  ìˆ˜ ìˆë‹¤.
  - ë§Œì•½ ë‹¤ì‹œ ì¡°íšŒí•´ì•¼ í•˜ë©´ ê¼­ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í•˜ì.

> ğŸ€ ë²Œí¬ ì—°ì‚°ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¬´ì‹œí•˜ê³  ì‹¤í–‰í•˜ê¸° ë•Œë¬¸ì—, ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ìˆëŠ” ì—”í‹°í‹°ì˜ ìƒíƒœì™€ DBì— ì—”í‹°í‹° ìƒíƒœê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆë‹¤.  
> ê¶Œì¥í•˜ëŠ” ë°©ì•ˆ
> 1. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ê°€ ì—†ëŠ” ìƒíƒœì—ì„œ ë²Œí¬ ì—°ì‚°ì„ ë¨¼ì € ì‹¤í–‰í•œë‹¤.
> 2. ë¶€ë“ì´í•˜ê²Œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ê°€ ìˆìœ¼ë©´ ë²Œí¬ ì—°ì‚° ì§í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™” í•œë‹¤.

## @EntityGraph
> ğŸ€ Fetch Join  
> ì¼ë°˜ì ìœ¼ë¡œ JPAì—ì„œ ì§€ì—° ë¡œë”©ì„ ì‚¬ìš©í•œë‹¤.
> ë§Œì•½ `SELECT m FROM Member m JOIN FETCH m.team`ì„ ì‹¤í–‰í•œ ë’¤ì—
> ë°˜í™˜ëœ ê°ì²´ì—ì„œ teamì— ëŒ€í•œ ì •ë³´ë¥¼ ì‚¬ìš©í•  ê²½ìš°
> `SELECT t FROM Team t WHERE t.id = :id`ì™€ ê°™ì€ ì¿¼ë¦¬ê°€ ì‹¤í–‰ëœë‹¤.
>
> ì¦‰, N + 1ë¬¸ì œê°€ ë°œìƒí•œë‹¤!
>
> Fetch Joinì„ ì‚¬ìš©í•˜ë©´ ì²˜ìŒì—
> `SELECT m FROM Member m JOIN Team t ON m.id = e.team_id`ê°€ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì—,
> ì¶”ê°€ë¡œ ì‹¤í–‰ë˜ëŠ” ì¿¼ë¦¬ë¬¸ì´ ì—†ë‹¤!

ì—°ê´€ëœ ì—”í‹°í‹°ë“¤ì„ SQL í•œ ë²ˆì— ì¡°íšŒí•˜ëŠ” ë°©ë²•  
member â¡ï¸ team ì€ **ì§€ì—° ë¡œë”© ê´€ê³„**ì´ë‹¤. ë”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì´ teamì˜ ë°ì´í„°ë¥¼ ì¡°íšŒí•  ë•Œ ë§ˆë‹¤ ì¿¼ë¦¬ê°€ ì‹¤í–‰ëœë‹¤. (N + 1 ë¬¸ì œ ë°œìƒ)
```java
@Test
public void findMemberLazy() throws Exception {
    //given
    //member1 -> teamA
    //member2 -> teamB
    Team teamA = new Team("teamA");
    Team teamB = new Team("teamB");
    teamRepository.save(teamA);
    teamRepository.save(teamB);
    memberRepository.save(new Member("member1", 10, teamA));
    memberRepository.save(new Member("member2", 20, teamB));
    
    em.flush();
    em.clear();
    
    //when
    List<Member> members = memberRepository.findAll();
    
    //then
    for (Member member : members) {
        member.getTeam().getName();
    } 
}
```
> ğŸ€ ë‹¤ìŒê³¼ ê°™ì´ ì§€ì—° ë¡œë”© ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
> ```java
>  // Hibernate ê¸°ëŠ¥ìœ¼ë¡œ í™•ì¸
>  Hibernate.isInitialized(member.getTeam())
> 
>  // JPA í‘œì¤€ ë°©ë²•ìœ¼ë¡œ í™•ì¸
>  PersistenceUnitUtil util = em.getEntityManagerFactory().getPersistenceUnitUtil();
>  util.isLoaded(member.getTeam());
> ```

ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ í•œ ë²ˆì— ì¡°íšŒí•˜ë ¤ë©´ `Fetch Join`ì´ í•„ìš”í•˜ë‹¤.

### JPQL Fetch Join
```java
@Query("SELECT m FROM Member m LEFT JOIN FETCH m.team")
List<Member> findMemberFetchJoin();
```

ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” JPAê°€ ì œê³µí•˜ëŠ” ì—”í‹°í‹° ê·¸ë˜í”„ ê¸°ëŠ¥ì„ í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•˜ê²Œ ë„ì™€ì¤€ë‹¤.
ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ JPQL ì—†ì´ Fetch Joinì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. (JPQL + ì—”í‹°í‹° ê·¸ë˜í”„ë„ ê°€ëŠ¥)

### EntityGraph
```java
// ê³µí†µ ë©”ì„œë“œ ì˜¤ë²„ë¼ì´ë“œ
@Override
@EntityGraph(attributePaths = {"team"})
List<Member> findAll();

// JPQL + ì—”í‹°í‹° ê·¸ë˜í”„
@EntityGraph(attributePaths = {"Team"})
@Query("SELECT m FROM Member m")
List<Member> findMemberEntityGraph();

// ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ì—ì„œ íŠ¹íˆ í¸ë¦¬í•˜ë‹¤.
@EntityGraph(attributePaths = {"team"})
List<Member> findUsername(String username);
```

### EntityGraph ì •ë¦¬
- ì‚¬ì‹¤ìƒ í˜ì¹˜ ì¡°ì¸(FETCH JOIN) ê°„í¸ ë²„ì „ì´ë‹¤.
- LEFT OUTER JOINì„ ì‚¬ìš©í•œë‹¤.

### [NamedEntityGraph ì‚¬ìš© ë°©ë²• - Member](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Fentity%2FMember.java)
```java
@NamedEntityGraph(
        name = "Member.all",
        attributeNodes = @NamedAttributeNode("team"))
public class Member { ... }
```
### [NamedEntityGraph ì‚¬ìš© ë°©ë²• - MemberRepository](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java)
```java
@EntityGraph("Member.all")
@Query("SELECT m FROM Member m")
List<Member> findMemberEntityGraph2();
```

## JPA Hint & Lock
### JPA ì¿¼ë¦¬ íŒíŠ¸(SQL íŒíŠ¸ê°€ ì•„ë‹Œ, JPA êµ¬í˜„ì²´ì—ê²Œ ì œê³µí•˜ëŠ” íŒíŠ¸)

#### [ì¿¼ë¦¬ íŒíŠ¸ ì‚¬ìš© - MemberRepository](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java)
```java
@QueryHints(value = @QueryHint(name = "org.hibernate.readOnly", value = "true"))
Member findReadOnlyByUsername(String username);
```

#### [ì¿¼ë¦¬ íŒíŠ¸ ì‚¬ìš© í…ŒìŠ¤íŠ¸ - MemberRepositoryTest](..%2Fsrc%2Ftest%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepositoryTest.java)
```java
@Test
public void queryHint() throws Exception {
    //given
    memberRepository.save(new Member("member1", 10));
    em.flush();
    em.clear();
    
    //when
    Member member = memberRepository.findReadOnlyByUsername("member1");
    member.setUsername("member2");
    em.flush(); //Update Query ì‹¤í–‰X
}
```

#### [ì¿¼ë¦¬ íŒíŠ¸ Page ì‚¬ìš© ì˜ˆì œ - MemberRepository.java](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java)
```java
@QueryHints(value = {@QueryHint(name = "org.hibernate.readOnly", value = "true")}, forCounting = true)
Page<Member> findByUsername(String name, Pageable pageable);
```
- `org.springframework.data.jpa.repository.QueryHints` ì• ë…¸í…Œì´ì…˜ ì‚¬ìš©
- `forCounting`: ë°˜í™˜ íƒ€ì…ìœ¼ë¡œ `Page` ì¸í„°í˜ì´ìŠ¤ë¥¼ ì ìš©í•˜ë©´ ì¶”ê°€ë¡œ í˜¸ì¶œí•˜ëŠ” í˜ì´ì§•ì„ ìœ„í•œ count ì¿¼ë¦¬ íŒíŠ¸ ì ìš©(ê¸°ë³¸ ê°’ `true`)

### [Lock - MemberRepository](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FMemberRepository.java)
```java
@Lock(LockModeType.PESSIMISTIC_WRITE)
List<Member> findLockByUsername(String name);
```
- `org.springframework.data.jpa.repository.Lock` ì• ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©