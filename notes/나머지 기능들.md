# ëª©ì°¨
ğŸ€ [Specifications (ëª…ì„¸)](#specifications-ëª…ì„¸)  
ğŸ€ [Query By Example](#query-by-example)  
ğŸ€ [Projections](#projections)  
ğŸ€ [ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬](#ë„¤ì´í‹°ë¸Œ-ì¿¼ë¦¬)  

## Specifications (ëª…ì„¸)
ì±… ë„ë©”ì¸ ì£¼ë„ ì„¤ê³„(Domain  Driven Design)ì€ SPECIFICATION(ëª…ì„¸)ë¼ëŠ” ê°œë…ì„ ì†Œê°œí•œë‹¤.  
ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” JPA Criteriaë¥¼ í™œìš©í•´ì„œ ì´ ê°œë…ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•œë‹¤.

### ìˆ ì–´ (predicate)
- ì°¸ ë˜ëŠ” ê±°ì§“ìœ¼ë¡œ í‰ê°€
- AND, OR ê°™ì€ ì—°ì‚°ìë¡œ ì¡°í•©í•´ì„œ ë‹¤ì–‘í•œ ê²€ìƒ‰ì¡°ê±´ì„ ì‰½ê²Œ ìƒì„±í•œë‹¤. (ì»´í¬ì§€íŠ¸ íŒ¨í„´)
- ì˜ˆ) ê²€ìƒ‰ ì¡°ê±´ í•˜ë‚˜í•˜ë‚˜
- ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” `org.springframework.data.jpa.main.Specification` í´ë˜ìŠ¤ë¡œ ì •ì˜í•œë‹¤.

### ëª…ì„¸ ì§€ê·¼ ì‚¬ìš© ë°©ë²•
#### JpaSpecificationExecutor ì¸í„°í˜ì´ìŠ¤ ìƒì†
```java
public interface MemberRepository extends JpaRepository<Member, Long>, JpaSpecificationExecutor<Member> { }
```

#### JpaSpecificationExecutor ì¸í„°í˜ì´ìŠ¤
```java
public interface JpaSpecificationExecutor<T> {
    Optional<T> findOne(@Nullable Specification<T> spec);
    List<T> findAll(Specification<T> spec);
    Page<T> findAll(Specification<T> spec, Pageable pageable);
    List<T> findAll(Specification<T> spec, Sort sort);
    long count(Secification<T> spec);
}
```

`Specification`ì„ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„ì„œ ê²€ìƒ‰ ì¡°ê±´ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.

### ëª…ì„¸ ì‚¬ìš© ì½”ë“œ
```java
@Test
void specBasic() throws Exception {
    // given
    Team teamA = new Team("teamA");
    em.persist(teamA);

    Member member1 = new Member("member1", 0, teamA);
    Member member2 = new Member("member2", 0, teamA);
    em.persist(member1);
    em.persist(member2);
    
    em.flush();
    em.clear();
    
    // when
    Specification<Member> spec = MemberSpec.username("member1").and(MemberSpec.teamName("teamA"));
    List<Member> result = memberRepository.findAll(spec);
    
    // then
    Assertions.assertThat(result.size()).isEqualTo(1);
}
```
- `Specification`ì„ êµ¬í˜„í•˜ë©´ ëª…ì„¸ë“¤ì„ ì¡°ë¦½í•  ìˆ˜ ìˆë‹¤. `where()`, `and()`, `or()`, `not()` ì œê³µ
- `findAll`ì„ ë³´ë©´ íšŒì› ì´ë¦„ ëª…ì„¸(`username`)ì™€ íŒ€ ì´ë¦„ ëª…ì„¸(`teamName`)ë¥¼ `and`ë¡œ ì¡°í•©í•´ì„œ ê²€ìƒ‰ ì¡°ê±´ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.

#### MemberSpec ëª…ì„¸ ì½”ë“œ
```java
public class MemberSpec {
    
    public static Specification<Member> teamName(final String teamName) {
        return (Specification<Member>) (root, query, builder) -> {
            if (StringUtils.isEmpty(teamName)) {
                return null;
            }
            
            Join<Member, Team> t = root.join("team", JoinType.INNER); // íšŒì›ê³¼ ì¡°ì¸
            return builder.equal(t.get("name"), teamName);
        };
    }

    public static Specification<Member> username(final String username) {
        return (Specification<Member>) (root, query, builder) -> 
            builder.equal(root.get("username"), username);
    }
}
```
- ëª…ì„¸ë¥¼ ì •ì˜í•˜ë ¤ë©´ `Specification` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œë‹¤.
- ëª…ì„¸ë¥¼ ì •ì˜í•  ë•ŒëŠ” `toPredicate(...)` ë©”ì„œë“œë§Œ êµ¬í˜„í•˜ë©´ ë˜ëŠ”ë° JPA Criteriaì˜ `root`, `CriteriaQuery`, `CriteriaBuilder` í´ë˜ìŠ¤ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ì œê³µí•œë‹¤.

> ğŸš¨ ì‹¤ë¬´ì—ì„œëŠ” JPA Criteriaë¥¼ ê±°ì˜ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤. QueryDSL ì„ ì‚¬ìš©í•˜ì.

## Query By Example
> ğŸ€ [ìŠ¤í”„ë§ ê³µì‹ ë¬¸ì„œ](https://docs.spring.io/spring-data/jpa/reference/repositories/query-by-example.html)

### [QueryByExampleTest](..%2Fsrc%2Ftest%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FQueryByExampleTest.java)
```java
@SpringBootTest
@Transactional
public class QueryByExampleTest {
    
    @Autowired
    MemberRepository memberRepository;
    
    @Autowired
    EntityManager em;
    
    @Test
    void basic() throws Exception {
        // given
        Team teamA = new Team("teamA");
        em.persist(teamA);

        em.persist(new Member("member1", 0, teamA));
        em.persist(new Member("member2", 0, teamA));
        
        em.flush();
        
        // when
        // Probe ìƒì„±
        Member member = new Member("member1");
        Team team = new Team("team"); // ë‚´ë¶€ ì¡°ì¸ìœ¼ë¡œ teamA ê°€ëŠ¥
        member.setTeam(team);
        
        // ExampleMatcher ìƒì„±, age í”„ë¡œí¼í‹°ëŠ” ë¬´ì‹œ
        ExampleMatcher matcher = ExampleMatcher.matching()
                .withIgnorePaths("age");

        Example<Member> example = Example.of(member, matcher);

        List<Member> result = memberRepository.findAll(example);
        
        // then
        assertThat(result.size()).isEqualTo(1);
    }
}
```

- Probe: í•„ë“œì— ë°ì´í„°ê°€ ìˆëŠ” ì‹¤ì œ ë„ë©”ì¸ ê°ì²´
- ExampleMatcher: íŠ¹ì • í•„ë“œë¥¼ ì¼ì¹˜ ì‹œí‚¤ëŠ” ìƒì„¸í•œ ì •ë³´ ì œê³µ, ì¬ì‚¬ìš© ê°€ëŠ¥
- Example: Probeì™€ ExampleMatcherë¡œ êµ¬ì„±, ì¿¼ë¦¬ë¥¼ ìƒì„±í•˜ëŠ”ë° ì‚¬ìš©

### ì¥ì 
- ë™ì  ì¿¼ë¦¬ë¥¼ í¸ë¦¬í•˜ê²Œ ì²˜ë¦¬
- ë„ë©”ì¸ ê°ì²´ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
- ë°ì´í„° ì €ì¥ì†Œë¥¼ RDBì—ì„œ NOSQLë¡œ ë³€ê²½í•´ë„ ì½”ë“œ ë³€ê²½ì´ ì—†ê²Œ ì¶”ìƒí™” ë˜ì–´ ìˆë‹¤.
- ìŠ¤í”„ë§ ë°ì´í„° JPA `JpaRepository` ì¸í„°í˜ì´ìŠ¤ì— ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆë‹¤.

### ë‹¨ì 
- ì¡°ì¸ì€ ê°€ëŠ¥í•˜ì§€ë§Œ ë‚´ë¶€ ì¡°ì¸(INNER JOIN)ë§Œ ê°€ëŠ¥í•˜ë‹¤. ì™¸ë¶€ ì¡°ì¸(LEFT JOIN)ì€ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.
- ë‹¤ìŒê³¼ ê°™ì€ ì¤‘ì²© ì œì•½ì¡°ê±´ì€ ì•ˆëœë‹¤.
  - `firstname = ?0 or (firstname = ?1 and lastname = ?2)`
- ë§¤ì¹­ ì¡°ê±´ì´ ë§¤ìš° ë‹¨ìˆœí•˜ë‹¤.
  - ë¬¸ì: `starts/contains/ends/regex`
  - ë‹¤ë¥¸ ì†ì„±: ì •í™•í•œ ë§¤ì¹­ (`=`)ë§Œ ì§€ì›í•œë‹¤.

### ì •ë¦¬
- ì‹¤ë¬´ì—ì„œ ì‚¬ìš©í•˜ê¸°ì—ëŠ” ë§¤ì¹­ ì¡°ê±´ì´ ë„ˆë¬´ ë‹¨ìˆœí•˜ê³ , LEFT ì¡°ì¸ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.
- ì‹¤ë¬´ì—ì„œëŠ” QueryDSL ì„ ì‚¬ìš©í•˜ì.

## Projections
> ğŸ€ [ìŠ¤í”„ë§ ê³µì‹ ë¬¸ì„œ](https://docs.spring.io/spring-data/jpa/reference/repositories/projections.html)

ì—”í‹°í‹° ëŒ€ì‹ ì— DTOë¥¼ í¸ë¦¬í•˜ê²Œ ì¡°íšŒí•  ë•Œ ì‚¬ìš©í•œë‹¤.  
ì „ì²´ ì—”í‹°í‹°ê°€ ì•„ë‹ˆë¼ ë§Œì•½ íšŒì› ì´ë¦„ë§Œ ì¡°íšŒí•˜ê³  ì‹¶ë‹¤ë©´?  
```java
public interface UsernameOnly {
    String getUsername();
}
```
- ì¡°íšŒí•  ì—”í‹°í‹°ì˜ í•„ë“œë¥¼ getter í˜•ì‹ìœ¼ë¡œ ì§€ì •í•˜ë©´ í•´ë‹¹ í•„ë“œë§Œ ì„ íƒí•´ì„œ ì¡°íšŒí•œë‹¤. (Projection)
```java
public interface MemberRepository extends JpaRepository<Member, Long> {
    List<UsernameOnly> findProjectionsByUsername(String username);    
}
```
- ë©”ì„œë“œ ì´ë¦„ì€ ììœ , ë°˜í™˜ íƒ€ì…ìœ¼ë¡œ ì¸ì§€í•œë‹¤.

### í…ŒìŠ¤íŠ¸ ì½”ë“œ 
```java
@Test
void projections() throws Exception {
    // given
    Team teamA = new Team("teamA");
    em.persist(teamA);

    Member m1 = new Member("m1", 0, teamA);
    Member m2 = new Member("m2", 0, teamA);
    em.persist(m1);
    em.persist(m2);
    em.flush();
    em.clear();
    
    //when
    List<UsernameOnly> result = memberRepository.findProjectionsByUsername("m1");

    //then
    Assertions.assertThat(result.size()).isEqualTo(1);
}
```

```sql
SELECT m.username FROM member m WHERE m.username = 'm1';
```
SQLì—ì„œë„ SELECT ì ˆì—ì„œ username ë§Œ ì¡°íšŒ (Projection)í•˜ëŠ” ê²ƒì„ í™•ì¸


### ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ Closed Projections
í”„ë¡œí¼í‹° í˜•ì‹(Getter)ì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•˜ë©´ êµ¬í˜„ì²´ëŠ” ìŠ¤í”„ë§ ë°ì´í„° JPAê°€ ì œê³µí•œë‹¤.
```java
public interface UsernameOnly {
    String getUsername();
}
```

### ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ Open Projections
ë‹¤ìŒê³¼ ê°™ì´ ìŠ¤í”„ë§ì˜ SpEL ë¬¸ë²•ë„ ì§€ì›í•œë‹¤.
```java
public interface UsernameOnly {
    @Value("#{target.username ' ' + target.age + ' ' + target.team.name}")
    String getUsername();
}
```
ë‹¨, ì´ë ‡ê²Œ SpELë¬¸ë²•ì„ ì‚¬ìš©í•˜ë©´, DBì—ì„œ ì—”í‹°í‹° í•„ë“œë¥¼ ëª¨ë‘ ì¡°íšŒí•œ ë‹¤ìŒì— ê³„ì‚°í•œë‹¤. ë”°ë¼ì„œ JPQL SELECT ì ˆ ìµœì í™”ê°€ ì•ˆëœë‹¤.

### í´ë˜ìŠ¤ ê¸°ë°˜ Projection
ë‹¤ìŒê³¼ ê°™ì´ ì¸í„°í˜ì´ìŠ¤ê°€ ì•„ë‹Œ êµ¬ì²´ì ì¸ DTO í˜•ì‹ë„ ê°€ëŠ¥í•˜ë‹¤.  
ìƒì„±ìì˜ íŒŒë¼ë¯¸í„° ì´ë¦„ìœ¼ë¡œ ë§¤ì¹­
```java
public class UsernameOnlyDTO {
    private final String username;

    public UsernameOnlyDTO(String username) {
        this.username = username;
    }

    public String getUsername() {
        return username;
    }
}
```

### ë™ì  Projections
ë‹¤ìŒê³¼ ê°™ì´ Generic Typeì„ ì£¼ë©´, ë™ì ìœ¼ë¡œ í”„ë¡œì ì…˜ ë°ì´í„°ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë‹¤.
```java
<T> List<T> findProjectionsByUsername(String username, Class<T> Type);
```

#### ì‚¬ìš© ì½”ë“œ
```java
List<UsernameOnly> result = memberRepository.findProjectionsByUsername("m1", UsernameOnly.class)
```

### ì¤‘ì²© êµ¬ì¡° ì²˜ë¦¬
```java
public interface NestedClosedProjection {
    String getUsername();
    TeamInfo getTeam();
    
    interface TeamInfo {
        String getTeam();
    }
}
```

```sql
SELECT
    m.username AS col_0_0_,
    t.teamid AS col_1_0_,
    t.teamid AS teamid1_2_,
    t.name AS name2_2_
FROM
    member m
        LEFT OUTER JOIN
    team t
    ON m.teamid=t.teamid
WHERE
    m.username=?
```

### ì£¼ì˜
- í”„ë¡œì ì…˜ ëŒ€ìƒì´ root ì—”í‹°í‹°ë©´, JPQL SELECT ì ˆì„ ìµœì í™”í•  ìˆ˜ ìˆë‹¤.
- í”„ë¡œì ì…˜ ëŒ€ìƒì´ ROOTê°€ ì•„ë‹ˆë©´
  - LEFT OUTER JOIN ì²˜ë¦¬ë¥¼ í•œë‹¤.
  - ëª¨ë“  í•„ë“œë¥¼ SELECT í•´ì„œ ì—”í‹°í‹°ë¡œ ì¡°íšŒí•œ ë‹¤ìŒì— ê³„ì‚°í•œë‹¤.

### ì •ë¦¬
- í”„ë¡œì ì…˜ ëŒ€ìƒì´ root ì—”í‹°í‹°ë©´ ìœ ìš©í•˜ë‹¤.
- í”„ë¡œì ì…˜ ëŒ€ìƒì´ root ì—”í‹°í‹°ë¥¼ ë„˜ì–´ê°€ë©´ JPQL SELECT ìµœì í™”ê°€ ì•ˆëœë‹¤.
- ì‹¤ë¬´ì˜ ë³µì¡í•œ ì¿¼ë¦¬ë¥¼ í•´ê²°í•˜ê¸°ì—ëŠ” í•œê³„ê°€ ìˆë‹¤.
- ì‹¤ë¬´ì—ì„œëŠ” ë‹¨ìˆœí•  ë•Œë§Œ ì‚¬ìš©í•˜ê³ , ì¡°ê¸ˆì´ë¼ê³  ë³µì¡í•´ì§€ë©´ QueryDSL ì„ ì‚¬ìš©í•˜ì.

## ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬
ê°€ê¸‰ì  ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²ƒì´ ì¢‹ë‹¤.  
ì •ë§ ì–´ì©” ìˆ˜ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì‚¬ìš©í•œë‹¤.  
ìµœê·¼ì— ë‚˜ì˜¨ ê¶ê·¹ì˜ ë°©ë²• â¡ï¸ìŠ¤í”„ë§ ë°ì´í„° Projections í™œìš©

### ìŠ¤í”„ë§ ë°ì´í„° JPA ê¸°ë°˜ ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬
- í˜ì´ì§• ì§€ì›
- ë°˜í™˜ íƒ€ì…
  - Object[]
  - Tuple
  - DTO(ìŠ¤í”„ë§ ë°ì´í„° ì¸í„°í˜ì´ìŠ¤ Projections ì§€ì›)
- ì œì•½
  - Sort íŒŒë¼ë¯¸í„°ë¥¼ í†µí•œ ì •ë ¬ì´ ì •ìƒ ë™ì‘í•˜ì§€ ì•Šì„ ìˆ˜ ìˆë‹¤. (ë¯¿ì§€ ë§ê³  ì§ì ‘ ì²˜ë¦¬í•˜ì.)
  - JPQL ì²˜ëŸ¼ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì‹œì ì— ë¬¸ë²•ì„ í™•ì¸í•  ìˆ˜ ì—†ë‹¤.
  - ë™ì  ì¿¼ë¦¬ëŠ” ë¶ˆê°€ëŠ¥í•˜ë‹¤.

### JPA ë„¤ì´í‹°ë¸Œ SQL ì§€ì›
```java
public interface MemberRepository extends JpaRepository<Member, Long> {

  @Query(value = "SELECT * FROM member WHERE username = ?", nativeQuery = true)
  Member findByNativeQuery(String username);
}
```
- JPQLì€ ìœ„ì¹˜ ê¸°ë°˜ íŒŒë¼ë¯¸í„°ë¥¼ 1ë¶€í„° ì‹œì‘í•˜ì§€ë§Œ ë„¤ì´í‹°ë¸Œ SQLì€ 0ë¶€í„° ì‹œì‘í•œë‹¤.
- ë„¤ì´í‹°ë¸Œ SQLì„ ì—”í‹°í‹°ê°€ ì•„ë‹Œ DTOë¡œ ë³€í™˜í•˜ë ¤ë©´
  - DTO ëŒ€ì‹  JPA TUPLE ì¡°íšŒ
  - DTO ëŒ€ì‹  MAP ì¡°íšŒ
  - @SqlResultSetMapping â¡ï¸ ë³µì¡
  - Hibernate ResultTransformer ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤. â¡ï¸ ë³µì¡
  - ë„¤ì´í‹°ë¸Œ SQLì„ DTOë¡œ ì¡°íšŒí•  ë•ŒëŠ” `jdbcTemplate` or `myBatis`ë¥¼ ê¶Œì¥í•œë‹¤.

### Projections í™œìš©
ì˜ˆ) ìŠ¤í”„ë§ ë°ì´í„° JPA ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ + ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ Projections í™œìš©
```java
@Query(value = "SELECT m.member_id as id, m.username, t.name as teamName " +
             "FROM member m left join team t ON m.team_id = t.team_id",
             countQuery = "SELECT count(*) from member",
             nativeQuery = true)
Page<MemberProjection> findByNativeProjection(Pageable pageable);
```

### ë™ì  ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬
- í•˜ì´ë²„ë„¤ì´íŠ¸ë¥¼ ì§ì ‘ í™œìš©í•œë‹¤.
- ìŠ¤í”„ë§ `JdbcTemplate`, `Mybatis`, `jooq` ê°™ì€ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•œë‹¤.

ì˜ˆ) í•˜ì´ë²„ë„¤ì´íŠ¸ ê¸°ëŠ¥ ì‚¬ìš©
```java
//given
String sql = "select m.username as username from member m";

List<MemberDto> result = em.createNativeQuery(sql)
       .setFirstResult(0)
       .setMaxResults(10)
       .unwrap(NativeQuery.class)
       .addScalar("username")
       .setResultTransformer(Transformers.aliasToBean(MemberDto.class))
       .getResultList();
```
