# ëª©ì°¨
ğŸ€ [Specifications (ëª…ì„¸)](#specifications-ëª…ì„¸)
ğŸ€ [Query By Example](#query-by-example)
ğŸ€ [Projections](#projections)
ğŸ€ [ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬](#ë„¤ì´í‹°ë¸Œ-ì¿¼ë¦¬)

## Specifications (ëª…ì„¸)
ì±… ë„ë©”ì¸ ì£¼ë„ ì„¤ê³„(Domain  Driven Design)ì€ SPECIFICATION(ëª…ì„¸)ë¼ëŠ” ê°œë…ì„ ì†Œê°œí•œë‹¤.  
ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” JPA Criteriaë¥¼ í™œìš©í•´ì„œ ì´ ê°œë…ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•œë‹¤.

### ìˆ ì–´ (predicate)
- ì°¸ ë˜ëŠ” ê±°ì§“ìœ¼ë¡œ í‰ê°€
- AND, OR ê°™ì€ ì—°ì‚°ìë¡œ ì¡°í•©í•´ì„œ ë‹¤ì–‘í•œ ê²€ìƒ‰ì¡°ê±´ì„ ì‰½ê²Œ ìƒì„±í•œë‹¤. (ì»´í¬ì§€íŠ¸ íŒ¨í„´)
- ì˜ˆ) ê²€ìƒ‰ ì¡°ê±´ í•˜ë‚˜í•˜ë‚˜
- ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” `org.springframework.data.jpa.main.Specification` í´ë˜ìŠ¤ë¡œ ì •ì˜í•œë‹¤.

### ëª…ì„¸ ì§€ê·¼ ì‚¬ìš© ë°©ë²•
#### JpaSpecificationExecutor ì¸í„°í˜ì´ìŠ¤ ìƒì†
```java
public interface MemberRepository extends JpaRepository<Member, Long>, JpaSpecificationExecutor<Member> { }
```

#### JpaSpecificationExecutor ì¸í„°í˜ì´ìŠ¤
```java
public interface JpaSpecificationExecutor<T> {
    Optional<T> findOne(@Nullable Specification<T> spec);
    List<T> findAll(Specification<T> spec);
    Page<T> findAll(Specification<T> spec, Pageable pageable);
    List<T> findAll(Specification<T> spec, Sort sort);
    long count(Secification<T> spec);
}
```

`Specification`ì„ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„ì„œ ê²€ìƒ‰ ì¡°ê±´ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.

### ëª…ì„¸ ì‚¬ìš© ì½”ë“œ
```java
@Test
void specBasic() throws Exception {
    // given
    Team teamA = new Team("teamA");
    em.persist(teamA);

    Member member1 = new Member("member1", 0, teamA);
    Member member2 = new Member("member2", 0, teamA);
    em.persist(member1);
    em.persist(member2);
    
    em.flush();
    em.clear();
    
    // when
    Specification<Member> spec = MemberSpec.username("member1").and(MemberSpec.teamName("teamA"));
    List<Member> result = memberRepository.findAll(spec);
    
    // then
    Assertions.assertThat(result.size()).isEqualTo(1);
}
```
- `Specification`ì„ êµ¬í˜„í•˜ë©´ ëª…ì„¸ë“¤ì„ ì¡°ë¦½í•  ìˆ˜ ìˆë‹¤. `where()`, `and()`, `or()`, `not()` ì œê³µ
- `findAll`ì„ ë³´ë©´ íšŒì› ì´ë¦„ ëª…ì„¸(`username`)ì™€ íŒ€ ì´ë¦„ ëª…ì„¸(`teamName`)ë¥¼ `and`ë¡œ ì¡°í•©í•´ì„œ ê²€ìƒ‰ ì¡°ê±´ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.

#### MemberSpec ëª…ì„¸ ì½”ë“œ
```java
public class MemberSpec {
    
    public static Specification<Member> teamName(final String teamName) {
        return (Specification<Member>) (root, query, builder) -> {
            if (StringUtils.isEmpty(teamName)) {
                return null;
            }
            
            Join<Member, Team> t = root.join("team", JoinType.INNER); // íšŒì›ê³¼ ì¡°ì¸
            return builder.equal(t.get("name"), teamName);
        };
    }

    public static Specification<Member> username(final String username) {
        return (Specification<Member>) (root, query, builder) -> 
            builder.equal(root.get("username"), username);
    }
}
```
- ëª…ì„¸ë¥¼ ì •ì˜í•˜ë ¤ë©´ `Specification` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œë‹¤.
- ëª…ì„¸ë¥¼ ì •ì˜í•  ë•ŒëŠ” `toPredicate(...)` ë©”ì„œë“œë§Œ êµ¬í˜„í•˜ë©´ ë˜ëŠ”ë° JPA Criteriaì˜ `root`, `CriteriaQuery`, `CriteriaBuilder` í´ë˜ìŠ¤ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ì œê³µí•œë‹¤.

> ğŸš¨ ì‹¤ë¬´ì—ì„œëŠ” JPA Criteriaë¥¼ ê±°ì˜ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤. QueryDSL ì„ ì‚¬ìš©í•˜ì.

## Query By Example
> ğŸ€ [ìŠ¤í”„ë§ ê³µì‹ ë¬¸ì„œ](https://docs.spring.io/spring-data/jpa/reference/repositories/query-by-example.html)

### [QueryByExampleTest](..%2Fsrc%2Ftest%2Fjava%2Fddangme%2Fspringdatajpa%2Frepository%2FQueryByExampleTest.java)
```java
@SpringBootTest
@Transactional
public class QueryByExampleTest {
    
    @Autowired
    MemberRepository memberRepository;
    
    @Autowired
    EntityManager em;
    
    @Test
    void basic() throws Exception {
        // given
        Team teamA = new Team("teamA");
        em.persist(teamA);

        em.persist(new Member("member1", 0, teamA));
        em.persist(new Member("member2", 0, teamA));
        
        em.flush();
        
        // when
        // Probe ìƒì„±
        Member member = new Member("member1");
        Team team = new Team("team"); // ë‚´ë¶€ ì¡°ì¸ìœ¼ë¡œ teamA ê°€ëŠ¥
        member.setTeam(team);
        
        // ExampleMatcher ìƒì„±, age í”„ë¡œí¼í‹°ëŠ” ë¬´ì‹œ
        ExampleMatcher matcher = ExampleMatcher.matching()
                .withIgnorePaths("age");

        Example<Member> example = Example.of(member, matcher);

        List<Member> result = memberRepository.findAll(example);
        
        // then
        assertThat(result.size()).isEqualTo(1);
    }
}
```

- Probe: í•„ë“œì— ë°ì´í„°ê°€ ìˆëŠ” ì‹¤ì œ ë„ë©”ì¸ ê°ì²´
- ExampleMatcher: íŠ¹ì • í•„ë“œë¥¼ ì¼ì¹˜ ì‹œí‚¤ëŠ” ìƒì„¸í•œ ì •ë³´ ì œê³µ, ì¬ì‚¬ìš© ê°€ëŠ¥
- Example: Probeì™€ ExampleMatcherë¡œ êµ¬ì„±, ì¿¼ë¦¬ë¥¼ ìƒì„±í•˜ëŠ”ë° ì‚¬ìš©

### ì¥ì 
- ë™ì  ì¿¼ë¦¬ë¥¼ í¸ë¦¬í•˜ê²Œ ì²˜ë¦¬
- ë„ë©”ì¸ ê°ì²´ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
- ë°ì´í„° ì €ì¥ì†Œë¥¼ RDBì—ì„œ NOSQLë¡œ ë³€ê²½í•´ë„ ì½”ë“œ ë³€ê²½ì´ ì—†ê²Œ ì¶”ìƒí™” ë˜ì–´ ìˆë‹¤.
- ìŠ¤í”„ë§ ë°ì´í„° JPA `JpaRepository` ì¸í„°í˜ì´ìŠ¤ì— ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆë‹¤.

### ë‹¨ì 
- ì¡°ì¸ì€ ê°€ëŠ¥í•˜ì§€ë§Œ ë‚´ë¶€ ì¡°ì¸(INNER JOIN)ë§Œ ê°€ëŠ¥í•˜ë‹¤. ì™¸ë¶€ ì¡°ì¸(LEFT JOIN)ì€ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.
- ë‹¤ìŒê³¼ ê°™ì€ ì¤‘ì²© ì œì•½ì¡°ê±´ì€ ì•ˆëœë‹¤.
  - `firstname = ?0 or (firstname = ?1 and lastname = ?2)`
- ë§¤ì¹­ ì¡°ê±´ì´ ë§¤ìš° ë‹¨ìˆœí•˜ë‹¤.
  - ë¬¸ì: `starts/contains/ends/regex`
  - ë‹¤ë¥¸ ì†ì„±: ì •í™•í•œ ë§¤ì¹­ (`=`)ë§Œ ì§€ì›í•œë‹¤.

### ì •ë¦¬
- ì‹¤ë¬´ì—ì„œ ì‚¬ìš©í•˜ê¸°ì—ëŠ” ë§¤ì¹­ ì¡°ê±´ì´ ë„ˆë¬´ ë‹¨ìˆœí•˜ê³ , LEFT ì¡°ì¸ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.
- ì‹¤ë¬´ì—ì„œëŠ” QueryDSL ì„ ì‚¬ìš©í•˜ì.






















## Projections
## ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬