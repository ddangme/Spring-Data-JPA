# λ©μ°¨
π€ [μ‚¬μ©μ μ •μ λ¦¬ν¬μ§€ν† λ¦¬ κµ¬ν„](#μ‚¬μ©μ-μ •μ-λ¦¬ν¬μ§€ν† λ¦¬-κµ¬ν„)  
π€ [Auditing](#auditing)  
π€ [Web ν™•μ¥ - λ„λ©”μΈ ν΄λμ¤ μ»¨λ²„ν„°](#web-ν™•μ¥---λ„λ©”μΈ-ν΄λμ¤-μ»¨λ²„ν„°)  
π€ [Web ν™•μ¥ - νμ΄μ§•κ³Ό μ •λ ¬](#web-ν™•μ¥---νμ΄μ§•κ³Ό-μ •λ ¬)  

## μ‚¬μ©μ μ •μ λ¦¬ν¬μ§€ν† λ¦¬ κµ¬ν„
- μ¤ν”„λ§ λ°μ΄ν„° JPA λ¦¬ν¬μ§€ν† λ¦¬λ” μΈν„°νμ΄μ¤λ§ μ •μν•κ³  κµ¬ν„μ²΄λ” μ¤ν”„λ§μ΄ μλ™ μƒμ„±ν•λ‹¤.
- μ¤ν”„λ§ λ°μ΄ν„° JPAκ°€ μ κ³µν•λ” μΈν„°νμ΄μ¤λ¥Ό μ§μ ‘ κµ¬ν„ν•΄μ•Ό ν•λ” κΈ°λ¥μ΄ μμ„ μ μλ‹¤.
- λ‹¤μ–‘ν• μ΄μ λ΅ μΈν„°νμ΄μ¤μ λ©”μ„λ“λ¥Ό μ§μ ‘ κµ¬ν„ν•κ³  μ‹¶λ‹¤λ©΄?
  - JPA μ§μ ‘ μ‚¬μ©ν•κΈ° (`EntityManager`)
  - μ¤ν”„λ§ JDBC Template μ‚¬μ©
  - MyBatis μ‚¬μ©
  - λ°μ΄ν„°λ² μ΄μ¤ μ»¤λ„¥μ… μ§μ ‘ μ‚¬μ© λ“±λ“±
  - Querydsl μ‚¬μ©

### μ‚¬μ©μ μ •μ μΈν„°νμ΄μ¤
```java
public interface MemberRepositoryCustom {
    List<Member> findMemberCustom();
}
```

### μ‚¬μ©μ μ •μ μΈν„°νμ΄μ¤ κµ¬ν„ ν΄λμ¤
```java
@RequiredArgsConstructor
public class MemberRepositoryImpl implements MemberRepositoryCustom {
    
    private final EntityManager em;
    
    @Override
    public List<Member> findMemberCustom() {
        return em.createQuery("SELECT m FROM Member m")
                .getResultList();
    }
}
```

### μ‚¬μ©μ μ •μ μΈν„°νμ΄μ¤ μƒμ†
```java
public interface MemberRepository extends JpaRepository<Member, Long>, MemberRepositoryCustom { }
```

### μ‚¬μ©μ μ •μ λ©”μ„λ“ νΈμ¶ μ½”λ“
```java
List<Member> result = memberRepository.findMemberCustom();
```

### μ‚¬μ©μ μ •μ κµ¬ν„ ν΄λμ¤
- κ·μΉ™: λ¦¬ν¬μ§€ν† λ¦¬ μΈν„°νμ΄μ¤ μ΄λ¦„ + `Impl`
- μ¤ν”„λ§ λ°μ΄ν„° JPAκ°€ μΈμ‹ν•΄μ„ μ¤ν”„λ§ λΉμΌλ΅ λ“±λ΅

> π€ Impl λ€μ‹  λ‹¤λ¥Έ μ΄λ¦„μΌλ΅ λ³€κ²½ν•κ³  μ‹¶λ‹¤λ©΄?
> 1. JavaConfig μ„¤μ •  
>     ```java
>     @EnableJpaRepositories(basePackages = "study.datajpa.repository", repositoryImplementationPostfix = "Impl")
>     ```
> 2. XML μ„¤μ •
>     ```xml
>    <repositories base-package="study.datajpa.repository" repository-impl-postfix="Impl" />
>     ```
> μ‹¤λ¬΄μ—μ„λ” μ£Όλ΅ QueryDSL μ΄λ‚ SpringJdbcTemplateμ„ ν•¨κ» μ‚¬μ©ν•  λ• μ‚¬μ©μ μ •μ λ¦¬ν¬μ§€ν† λ¦¬ κΈ°λ¥μ„ μμ£Ό μ‚¬μ©ν•λ‹¤.  
> ν•­μƒ μ‚¬μ©μ μ •μ λ¦¬ν¬μ§€ν† λ¦¬κ°€ ν•„μ”ν• κ²ƒμ€ μ•„λ‹λ‹¤. κ·Έλƒ¥ μ„μμ λ¦¬ν¬μ§€ν† λ¦¬λ¥Ό λ§λ“¤μ–΄λ„λλ‹¤.
> μλ¥Ό λ“¤μ–΄ `MemberQueryRepository`λ¥Ό μΈν„°νμ΄μ¤κ°€ μ•„λ‹ ν΄λμ¤λ΅ λ§λ“¤κ³  μ¤ν”„λ§ λΉμΌλ΅ λ“±λ΅ν•΄μ„ μ§μ ‘ μ‚¬μ©ν•΄λ„ λλ‹¤.

### μ‚¬μ©μ μ •μ λ¦¬ν¬μ§€ν† λ¦¬ κµ¬ν„ μµμ‹  λ°©μ‹
μ¤ν”„λ§ λ°μ΄ν„° 2.x λ¶€ν„°λ” μ‚¬μ©μ μ •μ κµ¬ν„ ν΄λμ¤μ— λ¦¬ν¬μ§€ν† λ¦¬ μΈν„°νμ΄μ¤ μ΄λ¦„ + `Impl`μ„ μ μ©ν•λ” λ€μ‹ μ—
μ‚¬μ©μ μ •μ μΈν„°νμ΄μ¤ λ… + `Impl` λ°©μ‹λ„ μ§€μ›ν•λ‹¤.  
μλ¥Ό λ“¤μ–΄μ„ μ„ μμ μ `MemberRepositoryImpl` λ€μ‹ μ— `MemberRepositoryCustomImpl` μ‘μ„±ν•΄λ„ λλ‹¤.

#### μµμ‹  μ‚¬μ©μ μ €μ μΈν„°νμ΄μ¤ κµ¬ν„ ν΄λμ¤ μμ 
```java
@RequiredArgsConstructor
public class MemberRepositoryCustomImpl implements MemberRepositoryCustom {
    private final EntityManager em;
    
    @Override
    public List<Member> findMemberCustom() {
        return em.createQuery("select m from Member m")
            .getResultList();
    }
}
```
κΈ°μ΅΄ λ°©μ‹λ³΄λ‹¤ μ΄ λ°©μ‹μ΄ μ‚¬μ©μ μ •μ μΈν„°νμ΄μ¤ μ΄λ¦„κ³Ό κµ¬ν„ ν΄λμ¤ μ΄λ¦„μ΄ λΉ„μ·ν•λ―€λ΅ λ” μ§κ΄€μ μ΄λ‹¤.
μ¶”κ°€λ΅ μ—¬λ¬ μΈν„°νμ΄μ¤λ¥Ό λ¶„λ¦¬ν•΄μ„ κµ¬ν„ν•λ” κ²ƒλ„ κ°€λ¥ν•κΈ° λ•λ¬Έμ— μƒλ΅­κ² λ³€κ²½λ μ΄ λ°©μ‹μ„ μ‚¬μ©ν•λ” κ²ƒμ„ λ” κ¶μ¥ν•λ‹¤.

## Auditing
μ—”ν‹°ν‹°λ¥Ό μƒμ„±, λ³€κ²½ν•  λ• λ³€κ²½ν• μ‚¬λκ³Ό μ‹κ°„μ„ μ¶”μ ν•κ³  μ‹¶λ‹¤λ©΄?
- λ“±λ΅μΌ
- μμ •μΌ
- λ“±λ΅μ
- μμ •μ

### [μμ JPA μ‚¬μ© - BaseEntity](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Fentity%2FBaseEntity.java)
λ“±λ΅μΌκ³Ό μμ •μΌλ§ μ μ©
```java
@MappedSuperclass
@Getter
public class BaseEntity {
    
    @Column(updatable = false)
    private LocalDateTime createdDate;
    
    private LocalDateTime updatedDate;
    
    @PrePersist
    public void prePersist() {
        LocalDateTime now = LocalDateTime.now();
        createdDate = now;
        updatedDate = now;
    }
    
    @PreUpdate
    public void preUpdate() {
        updatedDate = LocalDateTime.now();
    }
}
```

#### [μ‚¬μ© μμ‹ - Member](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Fentity%2FMember.java)
```java
public class Member extends BaseEntity { }
```

#### ν™•μΈ μ½”λ“
```java
@Test
public void jpaEventBaseEntity() throws Exception {
    //given
    Member member = new Member("member1");
    memberRepository.save(member); //@PrePersist
    Thread.sleep(100);
    member.setUsername("member2");
    em.flush(); //@PreUpdate
    em.clear();
    
    //when
    Member findMember = memberRepository.findById(member.getId()).get();
    
    //then
    System.out.println("findMember.createdDate = " + findMember.getCreatedDate());
    System.out.println("findMember.updatedDate = " + findMember.getUpdatedDate());
}
```

#### JPA μ£Όμ” μ΄λ²¤νΈ μ–΄λ…Έν…μ΄μ…
- @PrePersist, @PostPersist
- @PreUpdate, @PostUpdate

### [μ¤ν”„λ§ λ°μ΄ν„° JPA μ‚¬μ© - BaseEntity](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2Fentity%2FBaseEntity.java)
```java
@EntityListeners(AuditingEntityListener.class)
@MappedSuperclass
@Getter
public class BaseEntity {

    @CreatedDate
    @Column(updatable = false)
    private LocalDateTime createdDate;

    @LastModifiedDate
    private LocalDateTime updatedDate;
    
    @CreatedBy
    @Column(updatable = false)
    private String createdBy;
    
    @LastModifiedBy
    private String lastModifiedBy;

}
```
- `@EntityListeners(AuditingEntityListener.class` β΅οΈ μ—”ν‹°ν‹°μ— μ μ©

#### [μ¤ν”„λ§ λ¶€νΈ μ„¤μ • ν΄λμ¤μ— μ μ© - SpringDataJpaApplication](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2FSpringDataJpaApplication.java)
```java
@EnableJpaAuditing
@SpringBootApplication
public class SpringDataJpaApplication {

    public static void main(String[] args) {
        SpringApplication.run(SpringDataJpaApplication.class, args);
    }
}
```
- `@EnableJpaAuditing` β΅οΈ μ¤ν”„λ§ λ¶€νΈ μ„¤μ • ν΄λμ¤μ— μ μ©

#### [λ“±λ΅μ, μμ •μ μ²λ¦¬ - SpringDataJpaApplication](..%2Fsrc%2Fmain%2Fjava%2Fddangme%2Fspringdatajpa%2FSpringDataJpaApplication.java)
```java
@Bean
public AuditorAware<String> auditorProvider() {
    return () -> Optional.of(UUID.randomUUID().toString());
}
```
μ‹¤λ¬΄μ—μ„λ” μ„Έμ… μ •λ³΄λ‚, μ¤ν”„λ§ μ‹νλ¦¬ν‹° λ΅κ·ΈμΈ μ •λ³΄μ—μ„ IDλ¥Ό λ°›λ”λ‹¤.

#### μ‚¬μ© μ• λ…Έν…μ΄μ…
- `@CreatedDate`
- `@LastModifiedDate`
- `@CreatedBy`
- `@LastModifiedBy`

> π€ μ‹¤λ¬΄μ—μ„ λ€λ¶€λ¶„μ μ—”ν‹°ν‹°λ” λ“±λ΅μ‹κ°„, μμ •μ‹κ°„μ΄ ν•„μ”ν•μ§€λ§, λ“±λ΅μμ™€ μμ •μλ” ν•„μ”μ—†μ„ μλ„ μλ‹¤.
> κ·Έλμ„ λ‹¤μκ³Ό κ°™μ΄ Base νƒ€μ…μ„ λ¶„λ¦¬ν•κ³ , μ›ν•λ” νƒ€μ…μ„ μ„ νƒν•΄μ„ μƒμ†ν•λ‹¤.
> ```java
> public class BaseTimeEntity {
>     @CreatedDate
>     @Column(updatable = false)
>     private LocalDateTime createdDate;
> 
>     @LastModifiedDate
>     private LocalDateTime lastModifiedDate;
> }
> ```
> ```java
> public class BaseEntity extends BaseTimeEntity {
>    @CreatedBy
>    @Column(updatable = false)
>    private String createdBy;
> 
>    @LastModifiedBy
>    private String lastModifiedBy;
> }
> ```
> μ €μ¥ μ‹μ μ— λ“±λ΅μΌκ³Ό λ“±λ΅μΌ, μμ •μΌκ³Ό μμ •μλ„ κ°™μ€ λ°μ΄ν„°κ°€ μ €μ¥λλ‹¤.
> λ°μ΄ν„°κ°€ μ¤‘λ³µ μ €μ¥λλ” κ²ƒ κ°™μ§€λ§, μ΄λ ‡κ² ν•΄λ‘λ©΄ λ³€κ²½ μ»¬λΌλ§ ν™•μΈν•΄λ„ λ§μ§€λ§‰μ— μ—…λ°μ΄νΈν• μ μ €λ¥Ό
> ν™•μΈν•  μ μμΌλ―€λ΅ μ μ§€λ³΄μ κ΄€μ μ—μ„ νΈλ¦¬ν•λ‹¤.
> μ΄λ ‡κ² ν•μ§€ μ•μΌλ©΄ λ³€κ²½ μ»¬λΌμ΄ `null`μΌλ• λ“±λ΅ μ»¬λΌμ„ λ μ°Ύμ•„μ•Ό ν•λ‹¤.  
> μ €μ¥ μ‹μ μ— μ €μ¥ λ°μ΄ν„°λ§ μ…λ ¥ν•κ³  μ‹¶μΌλ©΄ `@EnableJpaAuditing(modifyOnCreate = false)` μµμ…μ„ μ‚¬μ©ν•λ©΄ λλ‹¤.

#### μ „μ²΄ μ μ©
`@EntityListeners(AuditingEntityListener.class)`λ¥Ό μƒλµν•κ³  μ¤ν”„λ§ λ°μ΄ν„° JPAκ°€
μ κ³µν•λ” μ΄λ²¤νΈλ¥Ό μ—”ν‹°ν‹° μ „μ²΄μ— μ μ©ν•λ ¤λ©΄ `orm.xml`μ— λ‹¤μκ³Ό κ°™μ΄ λ“±λ΅ν•λ©΄ λλ‹¤.

```xml
<?xml version="1.0" encoding="UTF-8"?>
 <entity-mappings xmlns="http://xmlns.jcp.org/xml/ns/persistence/orm"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence/orm http://xmlns.jcp.org/xml/ns/persistence/orm_2_2.xsd"
                  version="2.2">
     <persistence-unit-metadata>
         <persistence-unit-defaults>
             <entity-listeners>
                 <entity-listener class="org.springframework.data.jpa.domain.support.AuditingEntityListener"/>
             </entity-listeners>
         </persistence-unit-defaults>
     </persistence-unit-metadata>
</entity-mappings>
```

## Web ν™•μ¥ - λ„λ©”μΈ ν΄λμ¤ μ»¨λ²„ν„°
HTTP νλΌλ―Έν„°λ΅ λ„μ–΄μ¨ μ—”ν‹°ν‹°μ μ•„μ΄λ””λ΅ μ—”ν‹°ν‹° κ°μ²΄λ¥Ό μ°Ύμ•„μ„ λ°”μΈλ”©

### λ„λ©”μΈ ν΄λμ¤ μ»¨λ²„ν„° μ‚¬μ© μ „
```java
@RestController
@RequiredArgsConstructor
public class MemberController {

    private final MemberRepository memberRepository;

    @GetMapping("/members/{id}")
    public String findMember(@PathVariable("id") Long id) {
        Member member = memberRepository.findById(id).get();

        return member.getUsername();
    }
}
```
### λ„λ©”μΈ ν΄λμ¤ μ»¨λ²„ν„° μ‚¬μ© ν›„
```java
@RestController
@RequiredArgsConstructor
public class MemberController {

    private final MemberRepository memberRepository;

    @GetMapping("/members/{id}")
    public String findMember(@PathVariable("id") Member member) {
        return member.getUsername();
    }
}
```
- HTTP μ”μ²­μ€ νμ› `id`λ¥Ό λ°›μ§€λ§ λ„λ©”μΈ ν΄λμ¤ μ»¨λ²„ν„°κ°€ μ¤‘κ°„μ— λ™μ‘ν•΄μ„ νμ› μ—”ν‹°ν‹° κ°μ²΄λ¥Ό λ°ν™ν•λ‹¤.
- λ„λ©”μΈ ν΄λμ¤ μ»¨λ²„ν„°λ„ λ¦¬ν¬μ§€ν† λ¦¬λ¥Ό μ‚¬μ©ν•΄μ„ μ—”ν‹°ν‹°λ¥Ό μ°Ύλ”λ‹¤.

> π¨ λ„λ©”μΈ ν΄λμ¤ μ»¨λ²„ν„°λ΅ μ—”ν‹°ν‹°λ¥Ό νλΌλ―Έν„°λ΅ λ°›μΌλ©΄, μ΄ μ—”ν‹°ν‹°λ” λ‹¨μ μ΅°νμ©μΌλ΅ μ‚¬μ©ν•΄μ•Ό ν•λ‹¤.
> νΈλμ­μ…μ΄ μ—†λ” λ²”μ„μ—μ„ μ—”ν‹°ν‹°λ¥Ό μ΅°νν–κΈ° λ•λ¬Έμ—, μ—”ν‹°ν‹°λ¥Ό λ³€κ²½ν•΄λ„ DBμ— λ°μλμ§€ μ•λ”λ‹¤.

## Web ν™•μ¥ - νμ΄μ§•κ³Ό μ •λ ¬
